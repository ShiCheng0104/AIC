<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èˆ¹èˆ¶è®¾å¤‡ç›‘æ§ç³»ç»Ÿ</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- PapaParse CDN (CSVè§£æ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .fade-in { animation: fadeIn 0.5s ease-out; }
    .slide-up { animation: slideUp 0.3s ease-out; }
    
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    
    .loading-pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .menu-card { transition: all 0.3s ease; }
    .menu-card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    
    .device-card { transition: all 0.3s ease; }
    .device-card:hover { transform: scale(1.05); }
    
    .device-detail { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    
    /* åŠ è½½é®ç½© */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    
    .loading-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }
    
    input[type="range"]::-webkit-slider-track {
      background: #334155;
      height: 8px;
      border-radius: 4px;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #06b6d4;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.5);
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      background: #0891b2;
      transform: scale(1.2);
    }
    
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .param-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-normal { background: #22c55e; color: white; }
    .badge-warning { background: #eab308; color: white; }
    .badge-error { background: #ef4444; color: white; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 min-h-screen">

  <div id="app"></div>

  <script>
    // ==================== å­—æ®µæ˜ å°„è¡¨ ====================
    const FieldMapping = {
      // Aæ¶è®¾å¤‡
      'Ajia-0_v': { name: 'Aæ¶å³èˆ·è§’åº¦', unit: 'Â°', device: 'Aæ¶' },
      'Ajia-1_v': { name: 'Aæ¶å·¦èˆ·è§’åº¦', unit: 'Â°', device: 'Aæ¶' },
      'Ajia-2_v': { name: '1å¯åŠ¨æŸœç”µå‹', unit: 'V', device: 'Aæ¶' },
      'Ajia-3_v': { name: '1å¯åŠ¨æŸœç”µæµ', unit: 'A', device: 'Aæ¶' },
      'Ajia-4_v': { name: '2å¯åŠ¨æŸœç”µå‹', unit: 'V', device: 'Aæ¶' },
      'Ajia-5_v': { name: '2å¯åŠ¨æŸœç”µæµ', unit: 'A', device: 'Aæ¶' },
      
      // ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ
      '1-5-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '1-5-1_v': { name: 'Ubç”µå‹', unit: 'V', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '1-5-2_v': { name: 'Ucç”µå‹', unit: 'V', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '1-5-3_v': { name: 'Iaç”µæµ', unit: 'A', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-4_v': { name: 'Ibç”µæµ', unit: 'A', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-5_v': { name: 'Icç”µæµ', unit: 'A', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-10_v': { name: 'é¢‘ç‡', unit: 'Hz', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.01 },
      
      // äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ
      '13-14-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '13-14-1_v': { name: 'Ubç”µå‹', unit: 'V', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '13-14-2_v': { name: 'Ucç”µå‹', unit: 'V', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '13-14-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '13-14-10_v': { name: 'é¢‘ç‡', unit: 'Hz', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.01 },
      
      // ç»è½¦
      'PLC_point0_value': { name: 'ç»è½¦Aæ”¾ç¼†é•¿åº¦', unit: 'm', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point1_value': { name: 'ç»è½¦Aæ”¾ç¼†é€Ÿåº¦', unit: 'm/s', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point2_value': { name: 'ç»è½¦Aå¼ åŠ›', unit: 'kN', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point3_value': { name: 'ç»è½¦Bæ”¾ç¼†é•¿åº¦', unit: 'm', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point4_value': { name: 'ç»è½¦Bæ”¾ç¼†é€Ÿåº¦', unit: 'm/s', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point5_value': { name: 'ç»è½¦Bå¼ åŠ›', unit: 'kN', device: 'ç»è½¦ç³»ç»Ÿ' },
      
      // ç»è½¦å˜é¢‘å™¨
      '1-15-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ç»è½¦å˜é¢‘å™¨', scale: 0.1 },
      '1-15-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ç»è½¦å˜é¢‘å™¨' },
      '1-15-10_v': { name: 'é¢‘ç‡', unit: 'Hz', device: 'ç»è½¦å˜é¢‘å™¨', scale: 0.01 },
      
      // æŠ˜è‡‚åŠè½¦
      '13-11-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'æŠ˜è‡‚åŠè½¦æ¶²å‹', scale: 0.1 },
      '13-11-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'æŠ˜è‡‚åŠè½¦æ¶²å‹' },
      
      // å‘ç”µæœºç»„
      'P1_2': { name: 'è½¬é€Ÿ', unit: 'RPM', device: 'ä¸€å·æŸ´æ²¹å‘ç”µæœº' },
      'P1_3': { name: 'ç‡ƒæ²¹æ¶ˆè€—ç‡', unit: 'L/h', device: 'ä¸€å·æŸ´æ²¹å‘ç”µæœº' },
      'P1_66': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·æŸ´æ²¹å‘ç”µæœº' },
      'P1_24': { name: 'è½¬é€Ÿ', unit: 'RPM', device: 'äºŒå·æŸ´æ²¹å‘ç”µæœº' },
      'P1_25': { name: 'ç‡ƒæ²¹æ¶ˆè€—ç‡', unit: 'L/h', device: 'äºŒå·æŸ´æ²¹å‘ç”µæœº' },
      'P1_75': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'äºŒå·æŸ´æ²¹å‘ç”µæœº' },
      'P2_2': { name: 'è½¬é€Ÿ', unit: 'RPM', device: 'ä¸‰å·æŸ´æ²¹å‘ç”µæœº' },
      'P2_3': { name: 'ç‡ƒæ²¹æ¶ˆè€—ç‡', unit: 'L/h', device: 'ä¸‰å·æŸ´æ²¹å‘ç”µæœº' },
      'P2_51': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸‰å·æŸ´æ²¹å‘ç”µæœº' },
      
      // èˆµæ¡¨
      '1-2-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµA', scale: 0.1 },
      '1-2-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµA' },
      '1-3-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµB', scale: 0.1 },
      '1-3-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµB' },
      'P3_19': { name: 'æ–¹ä½å‘½ä»¤', unit: '%', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },
      'P3_20': { name: 'æ–¹ä½åé¦ˆ', unit: '%', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },
      'P3_21': { name: 'è½¬é€Ÿå‘½ä»¤', unit: 'RPM', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },
      'P3_22': { name: 'è½¬é€Ÿåé¦ˆ', unit: 'RPM', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },
      
      // æ¨è¿›å™¨
      'P3_15': { name: 'åŠŸç‡åé¦ˆ', unit: 'kW', device: 'ä¸€å·æ¨è¿›å˜é¢‘å™¨' },
      'P3_32': { name: 'åŠŸç‡å…è®¸', unit: 'kW', device: 'ä¸€å·æ¨è¿›å˜é¢‘å™¨' },
      'P4_15': { name: 'åŠŸç‡å…è®¸', unit: 'kW', device: 'äºŒå·æ¨è¿›å˜é¢‘å™¨' },
      'P4_16': { name: 'åŠŸç‡åé¦ˆ', unit: 'kW', device: 'äºŒå·æ¨è¿›å˜é¢‘å™¨' },
      'P3_18': { name: 'åŠŸç‡åé¦ˆ', unit: 'kW', device: 'è‰æ¨' },
      'P1_80': { name: 'ä¸»å¼€å…³ç”µæµ', unit: 'A', device: 'è‰æ¨' },
    };

    // ==================== æ–‡ä»¶åˆ—è¡¨ ====================
    const CSV_FILES = [
      'Ajia_plc_1.csv',
      'device_1_2_meter_102.csv',
      'device_1_3_meter_103.csv',
      'device_1_5_meter_105.csv',
      'device_1_15_meter_115.csv',
      'device_13_2_meter_1302.csv',
      'device_13_3_meter_1303.csv',
      'device_13_11_meter_1311.csv',
      'device_13_14_meter_1314.csv',
      'Jiaoche_plc_1.csv',
      'Port1_ksbg_1.csv',
      'Port1_ksbg_2.csv',
      'Port1_ksbg_3.csv',
      'Port1_ksbg_4.csv',
      'Port1_ksbg_5.csv',
      'Port2_ksbg_1.csv',
      'Port2_ksbg_2.csv',
      'Port2_ksbg_3.csv',
      'Port2_ksbg_4.csv',
      'Port3_ksbg_8.csv',
      'Port3_ksbg_9.csv',
      'Port3_ksbg_10.csv',
      'Port4_ksbg_7.csv',
      'Port4_ksbg_8.csv',
      'Port4_ksbg_9.csv'
    ];

    // ==================== å…¨å±€çŠ¶æ€ ====================
    const AppState = {
      currentPage: 'home',
      currentTimeIndex: 0,
      currentDate: null,           // å½“å‰é€‰ä¸­çš„æ—¥æœŸ
      availableDates: [],          // å¯ç”¨çš„æ—¥æœŸåˆ—è¡¨
      dateTimestamps: {},          // æŒ‰æ—¥æœŸåˆ†ç»„çš„æ—¶é—´æˆ³ { '2024-05-17': [...timestamps] }
      dateTimestampsOriginal: {},  // åŸå§‹å®Œæ•´æ—¶é—´æˆ³ï¼ˆæœªé‡‡æ ·ï¼‰
      timestamps: [],              // å½“å‰æ—¥æœŸçš„æ—¶é—´æˆ³ï¼ˆé‡‡æ ·åï¼‰
      devicesData: {},
      activeDetailId: null,
      loadingProgress: 0,
      showDatePicker: false,       // æ˜¯å¦æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
      samplingRate: 100,           // æ¯æ—¥é‡‡æ ·å¸§æ•°
      isDragging: false,           // æ˜¯å¦æ­£åœ¨æ‹–åŠ¨æ—¶é—´è½´
      pendingTimeIndex: null,      // å¾…æ›´æ–°çš„æ—¶é—´ç´¢å¼•ï¼ˆæ‹–åŠ¨ä¸­ï¼‰
      dataCache: new Map()         // æ•°æ®ç¼“å­˜ { timestamp: { deviceId: values } }
    };

    // ==================== å·¥å…·å‡½æ•° ====================
    const Utils = {
      formatTime(timeStr) {
        if (!timeStr) return '--:--:--';
        const parts = timeStr.split(' ');
        return parts.length > 1 ? parts[1] : timeStr;
      },
      
      formatDate(timeStr) {
        if (!timeStr) return '--';
        const parts = timeStr.split(' ');
        return parts.length > 0 ? parts[0] : timeStr;
      },
      
      getDateFromTimestamp(timeStr) {
        if (!timeStr) return null;
        const parts = timeStr.split(' ');
        return parts.length > 0 ? parts[0] : null;
      },
      
      // é‡‡æ ·å‡½æ•°ï¼šä»æ•°ç»„ä¸­å‡åŒ€é‡‡æ ·æŒ‡å®šæ•°é‡çš„å…ƒç´ 
      sampleArray(array, sampleCount) {
        if (!array || array.length === 0) return [];
        if (array.length <= sampleCount) return [...array];
        
        const samples = [];
        const totalCount = array.length;
        
        // æŒ‰100åˆ†ç‚¹é‡‡æ ·
        for (let i = 0; i < sampleCount; i++) {
          const index = Math.floor((i / (sampleCount - 1)) * (totalCount - 1));
          samples.push(array[index]);
        }
        
        return samples;
      },
      
      getDeviceIcon(name) {
        if (name.includes('Aæ¶')) return 'ğŸ—ï¸';
        if (name.includes('é—¨æ¶')) return 'ğŸ—ï¸';
        if (name.includes('ç»è½¦')) return 'âš™ï¸';
        if (name.includes('åŠè½¦')) return 'ğŸšœ';
        if (name.includes('èˆµæ¡¨')) return 'ğŸš¢';
        if (name.includes('æ¨è¿›') || name.includes('è‰æ¨')) return 'âš“';
        if (name.includes('å‘ç”µæœº')) return 'âš¡';
        return 'ğŸ“¦';
      },
      
      createElement(tag, className = '', innerHTML = '') {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (innerHTML) el.innerHTML = innerHTML;
        return el;
      },
      
      applyScale(value, scale) {
        if (!scale || scale === 1) return value;
        const num = parseFloat(value);
        return isNaN(num) ? value : (num * scale).toFixed(2);
      },
      
      isErrorValue(value) {
        return value === 'error' || value === null || value === undefined || value === '';
      },
      
      getValueStatus(value, mapping) {
        if (Utils.isErrorValue(value)) return 'error';
        const num = parseFloat(value);
        if (isNaN(num)) return 'normal';
        // å¯ä»¥æ ¹æ®mappingä¸­çš„é˜ˆå€¼åˆ¤æ–­ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        return 'normal';
      },
      
      // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
      showLoading(message = 'åŠ è½½ä¸­...') {
        let overlay = document.getElementById('loading-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'loading-overlay';
          overlay.className = 'loading-overlay';
          overlay.innerHTML = `
            <div class="bg-slate-800 rounded-xl p-6 shadow-2xl border border-slate-700">
              <div class="flex items-center space-x-4">
                <div class="loading-spinner w-8 h-8 border-4 border-cyan-400 border-t-transparent rounded-full"></div>
                <span class="text-white text-lg">${message}</span>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);
        }
        // å¼ºåˆ¶é‡ç»˜
        overlay.offsetHeight;
        overlay.classList.add('active');
      },
      
      // éšè—åŠ è½½åŠ¨ç”»
      hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.remove('active');
        }
      }
    };

    // ==================== æ•°æ®åŠ è½½å™¨ ====================
    const DataManager = {
      async loadAllData() {
        try {
          AppState.loadingProgress = 0;
          const totalFiles = CSV_FILES.length;
          let loadedFiles = 0;
          
          // å¹¶è¡ŒåŠ è½½æ‰€æœ‰CSVæ–‡ä»¶
          const promises = CSV_FILES.map(async (filename) => {
            try {
              const response = await fetch(`./data/${filename}`);
              if (!response.ok) {
                console.warn(`æ–‡ä»¶åŠ è½½å¤±è´¥: ${filename}`);
                return null;
              }
              const text = await response.text();
              
              return new Promise((resolve) => {
                Papa.parse(text, {
                  header: true,
                  skipEmptyLines: true,
                  complete: (results) => {
                    loadedFiles++;
                    AppState.loadingProgress = Math.round((loadedFiles / totalFiles) * 100);
                    this.updateLoadingUI();
                    resolve({ filename, data: results.data });
                  },
                  error: (error) => {
                    console.error(`è§£æå¤±è´¥: ${filename}`, error);
                    resolve(null);
                  }
                });
              });
            } catch (error) {
              console.error(`è¯»å–æ–‡ä»¶é”™è¯¯: ${filename}`, error);
              return null;
            }
          });
          
          const results = await Promise.all(promises);
          
          // ç»„ç»‡æ•°æ®ï¼šæŒ‰è®¾å¤‡åˆ†ç»„
          this.organizeDataByDevice(results.filter(r => r !== null));
          
          return true;
        } catch (error) {
          console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
          return false;
        }
      },
      
      organizeDataByDevice(fileResults) {
        const deviceMap = {};
        const timestampSet = new Set();
        const dateTimestamps = {};
        
        // éå†æ‰€æœ‰æ–‡ä»¶çš„æ•°æ®
        fileResults.forEach(({ filename, data }) => {
          if (!data || data.length === 0) return;
          
          // æ”¶é›†æ—¶é—´æˆ³å¹¶æŒ‰æ—¥æœŸåˆ†ç»„
          data.forEach(row => {
            if (row.csvTime) {
              timestampSet.add(row.csvTime);
              const date = Utils.getDateFromTimestamp(row.csvTime);
              if (date) {
                if (!dateTimestamps[date]) {
                  dateTimestamps[date] = [];
                }
                dateTimestamps[date].push(row.csvTime);
              }
            }
          });
          
          // éå†æ¯è¡Œæ•°æ®
          data.forEach((row, rowIndex) => {
            Object.keys(row).forEach(fieldKey => {
              if (fieldKey === 'csvTime' || fieldKey === '' || fieldKey === '_id') return;
              
              const mapping = FieldMapping[fieldKey];
              if (!mapping) return;
              
              const deviceName = mapping.device;
              
              if (!deviceMap[deviceName]) {
                deviceMap[deviceName] = {
                  name: deviceName,
                  icon: Utils.getDeviceIcon(deviceName),
                  parameters: {}
                };
              }
              
              if (!deviceMap[deviceName].parameters[fieldKey]) {
                deviceMap[deviceName].parameters[fieldKey] = {
                  displayName: mapping.name,
                  unit: mapping.unit || '',
                  scale: mapping.scale || 1,
                  values: []
                };
              }
              
              const rawValue = row[fieldKey];
              const scaledValue = mapping.scale 
                ? Utils.applyScale(rawValue, mapping.scale)
                : rawValue;
              
              deviceMap[deviceName].parameters[fieldKey].values.push({
                timestamp: row.csvTime,
                value: scaledValue,
                raw: rawValue
              });
            });
          });
        });
        
        // å¤„ç†æ—¥æœŸæ—¶é—´æˆ³ï¼šå»é‡å¹¶æ’åº
        Object.keys(dateTimestamps).forEach(date => {
          dateTimestamps[date] = [...new Set(dateTimestamps[date])].sort();
        });
        
        // ä¿å­˜åŸå§‹å®Œæ•´æ•°æ®
        AppState.dateTimestampsOriginal = JSON.parse(JSON.stringify(dateTimestamps));
        
        // å¯¹æ¯ä¸ªæ—¥æœŸè¿›è¡Œé‡‡æ ·
        const sampledDateTimestamps = {};
        Object.keys(dateTimestamps).forEach(date => {
          const originalFrames = dateTimestamps[date];
          const sampledFrames = Utils.sampleArray(originalFrames, AppState.samplingRate);
          sampledDateTimestamps[date] = sampledFrames;
          
          console.log(`æ—¥æœŸ ${date}: åŸå§‹ ${originalFrames.length} å¸§ -> é‡‡æ · ${sampledFrames.length} å¸§`);
        });
        
        AppState.dateTimestamps = sampledDateTimestamps;
        AppState.availableDates = Object.keys(sampledDateTimestamps).sort();
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºç¬¬ä¸€ä¸ªå¯ç”¨æ—¥æœŸ
        if (AppState.availableDates.length > 0) {
          AppState.currentDate = AppState.availableDates[0];
          AppState.timestamps = sampledDateTimestamps[AppState.currentDate];
          AppState.currentTimeIndex = 0;
        }
        
        AppState.devicesData = Object.values(deviceMap).map((device, idx) => ({
          id: idx,
          name: device.name,
          icon: device.icon,
          parameters: device.parameters
        }));
        
        console.log('è®¾å¤‡æ•°æ®åŠ è½½å®Œæˆ:', AppState.devicesData);
        console.log('å¯ç”¨æ—¥æœŸ:', AppState.availableDates);
        console.log('å½“å‰æ—¥æœŸé‡‡æ ·åå¸§æ•°:', AppState.timestamps.length);
      },
      
      updateLoadingUI() {
        const progressEl = document.getElementById('loading-progress');
        if (progressEl) {
          progressEl.textContent = `${AppState.loadingProgress}%`;
        }
      }
    };

    // ==================== é¡µé¢æ¸²æŸ“å™¨ ====================
    const Pages = {
      renderHome() {
        const menuItems = [
          { id: 'monitor', icon: 'ğŸ“Š', title: 'è®¾å¤‡ç›‘æ§', desc: 'å®æ—¶æŸ¥çœ‹è®¾å¤‡è¿è¡ŒçŠ¶æ€' },
          { id: 'reports', icon: 'ğŸ“‹', title: 'æŠ¥è¡¨ç»Ÿè®¡', desc: 'æ•°æ®åˆ†æä¸å†å²è®°å½•' },
          { id: 'settings', icon: 'âš™ï¸', title: 'ç³»ç»Ÿè®¾ç½®', desc: 'å‚æ•°é…ç½®ä¸ç®¡ç†' },
          { id: 'alerts', icon: 'ğŸ””', title: 'æŠ¥è­¦ç®¡ç†', desc: 'æ•…éšœé¢„è­¦ä¸é€šçŸ¥' }
        ];

        return `
          <div class="min-h-screen flex items-center justify-center p-8 fade-in">
            <div class="max-w-6xl w-full">
              <div class="text-center mb-12">
                <h1 class="text-6xl font-bold text-white mb-4">
                  <span class="mr-4">ğŸš¢</span>èˆ¹èˆ¶ç®¡ç†ç³»ç»Ÿ
                </h1>
                <p class="text-xl text-blue-200">æ™ºèƒ½ç›‘æ§ Â· ç²¾å‡†åˆ†æ Â· é«˜æ•ˆç®¡ç†</p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${menuItems.map((item, idx) => `
                  <div class="menu-card bg-gradient-to-br from-blue-600 to-blue-800 p-8 rounded-2xl shadow-xl cursor-pointer border border-blue-500/30"
                       onclick="Router.navigate('${item.id}')"
                       style="animation-delay: ${idx * 0.1}s">
                    <div class="text-6xl mb-4">${item.icon}</div>
                    <h3 class="text-2xl font-bold text-white mb-2">${item.title}</h3>
                    <p class="text-blue-200 text-sm">${item.desc}</p>
                  </div>
                `).join('')}
              </div>
              
              <div class="mt-12 text-center text-gray-400 text-sm">
                <p>Â© 2024 èˆ¹èˆ¶æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ v2.0 - å®æ—¶æ•°æ®ç‰ˆ</p>
              </div>
            </div>
          </div>
        `;
      },

      async renderMonitor() {
        if (Object.keys(AppState.devicesData).length === 0) {
          return `
            <div class="min-h-screen flex items-center justify-center">
              <div class="text-center">
                <div class="text-white text-2xl mb-4">æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...</div>
                <div class="text-cyan-400 text-4xl font-bold" id="loading-progress">0%</div>
              </div>
            </div>
          `;
        }

        const devices = AppState.devicesData;
        const currentTime = AppState.timestamps[AppState.currentTimeIndex] || '--';

        const html = `
          <div class="min-h-screen pb-32 fade-in">
            <div class="bg-slate-800 shadow-lg py-4 px-6 flex justify-between items-center">
              <div class="flex items-center space-x-4">
                <button onclick="Router.navigate('home')" 
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                  â† è¿”å›
                </button>
                <h1 class="text-2xl font-bold text-white">ğŸ“Š è®¾å¤‡ç›‘æ§</h1>
                <div class="px-3 py-1 bg-slate-700 rounded-lg">
                  <span class="text-cyan-400 text-sm font-mono">${currentTime}</span>
                </div>
              </div>
              <div class="text-gray-400 text-sm">
                å·²åŠ è½½ ${devices.length} ä¸ªè®¾å¤‡ | å½“å‰æ˜¾ç¤º ${AppState.timestamps.length} å¸§
              </div>
            </div>
            
            <div class="py-8 overflow-x-auto hide-scrollbar px-6">
              <div class="flex space-x-6" style="min-width: min-content;">
                ${devices.map(device => this.renderDeviceCard(device)).join('')}
              </div>
            </div>
            
            ${this.renderTimeline()}
          </div>
        `;
        
        return html;
      },

      renderDeviceCard(device) {
        // è·å–ç¬¬ä¸€ä¸ªæœ‰æ•ˆå‚æ•°ä½œä¸ºé¢„è§ˆ
        const firstParam = Object.values(device.parameters)[0];
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];
        let previewValue = '--';
        
        if (firstParam && firstParam.values.length > 0) {
          const valueData = TimelineHandler.findValueAtTime(firstParam, currentTime);
          previewValue = Utils.isErrorValue(valueData.value) 
            ? 'error' 
            : `${valueData.value} ${firstParam.unit}`;
        }
        
        return `
          <div class="device-card relative w-56 h-64 flex-shrink-0"
               onclick="DeviceHandler.toggleDetail(${device.id}, event)">
            <div class="w-full h-full bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-lg flex flex-col items-center justify-center cursor-pointer p-4">
              <div class="text-6xl mb-3">${device.icon}</div>
              <h3 class="text-white font-bold text-center mb-2">${device.name}</h3>
              <div class="text-xs text-blue-200 text-center break-words w-full device-preview-value">
                ${previewValue}
              </div>
              <div class="mt-2 text-xs text-blue-300">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
          </div>
        `;
      },

      renderTimeline() {
        if (AppState.timestamps.length === 0) return '';
        
        const progress = (AppState.currentTimeIndex / (AppState.timestamps.length - 1)) * 100;
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];
        
        return `
          <div class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-lg border-t border-slate-700 p-4 z-40">
            <div class="max-w-7xl mx-auto">
              <!-- æ—¥æœŸé€‰æ‹©å’Œæ—¶é—´æ˜¾ç¤º -->
              <div class="flex justify-between items-center mb-3">
                <div class="flex items-center space-x-4">
                  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
                  <div class="relative">
                    <button onclick="DatePickerHandler.toggle()" 
                            class="flex items-center space-x-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                      <span class="text-cyan-400 font-bold">ğŸ“… ${Utils.formatDate(currentTime)}</span>
                      <span class="text-gray-400 text-sm">â–¼</span>
                    </button>
                    
                    <!-- æ—¥æœŸé€‰æ‹©ä¸‹æ‹‰æ¡† -->
                    <div id="date-picker-dropdown" 
                         class="absolute bottom-full left-0 mb-2 bg-slate-800 rounded-lg shadow-2xl border border-slate-700 ${AppState.showDatePicker ? '' : 'hidden'}"
                         style="min-width: 300px; max-height: 400px; overflow-y: auto;">
                      <div class="p-3 border-b border-slate-700">
                        <h4 class="text-white font-bold text-sm">é€‰æ‹©æ—¥æœŸ</h4>
                        <p class="text-gray-400 text-xs mt-1">å…± ${AppState.availableDates.length} ä¸ªæ—¥æœŸ</p>
                      </div>
                      <div class="p-2">
                        ${AppState.availableDates.map(date => {
                          const isActive = date === AppState.currentDate;
                          const originalFrameCount = AppState.dateTimestampsOriginal[date]?.length || 0;
                          const sampledFrameCount = AppState.dateTimestamps[date]?.length || 0;
                          return `
                            <button onclick="DatePickerHandler.selectDate('${date}')"
                                    class="w-full text-left px-4 py-3 rounded-lg transition-colors mb-1 ${
                                      isActive 
                                        ? 'bg-cyan-600 text-white' 
                                        : 'hover:bg-slate-700 text-gray-300'
                                    }">
                              <div class="flex justify-between items-center">
                                <div>
                                  <div class="font-bold ${isActive ? 'text-white' : 'text-cyan-400'}">${date}</div>
                                  <div class="text-xs ${isActive ? 'text-cyan-100' : 'text-gray-500'}">
                                    åŸå§‹: ${originalFrameCount} å¸§ â†’ é‡‡æ ·: ${sampledFrameCount} å¸§
                                  </div>
                                </div>
                                ${isActive ? '<span class="text-xl">âœ“</span>' : ''}
                              </div>
                            </button>
                          `;
                        }).join('')}
                      </div>
                    </div>
                  </div>
                  
                  <!-- å½“å‰æ—¶é—´æ˜¾ç¤º -->
                  <div class="text-white font-mono text-sm">
                    <span class="text-gray-400">æ—¶é—´ï¼š</span>
                    <span class="text-cyan-400 font-bold ml-2 current-time-display">
                      ${Utils.formatTime(currentTime)}
                    </span>
                  </div>
                </div>
                
                <div class="text-gray-400 text-xs frame-counter">
                  å¸§ ${AppState.currentTimeIndex + 1} / ${AppState.timestamps.length}
                </div>
              </div>
              
              <!-- æ—¶é—´è½´æ»‘å— -->
              <div class="relative mb-4">
                <input type="range" 
                       id="timeline-slider"
                       min="0" 
                       max="${AppState.timestamps.length - 1}" 
                       value="${AppState.currentTimeIndex}"
                       onmousedown="TimelineHandler.onSliderStart()"
                       ontouchstart="TimelineHandler.onSliderStart()"
                       oninput="TimelineHandler.onSliderMove(this.value)"
                       onmouseup="TimelineHandler.onSliderEnd(this.value)"
                       ontouchend="TimelineHandler.onSliderEnd(this.value)"
                       onchange="TimelineHandler.onSliderEnd(this.value)"
                       class="w-full h-2"
                       style="background: linear-gradient(to right, #06b6d4 ${progress}%, #334155 ${progress}%)">
                
                <!-- æ—¶é—´åˆ»åº¦ -->
                <div class="flex justify-between mt-2 px-1">
                  ${this.generateTimeMarks()}
                </div>
              </div>
              
              <!-- æ§åˆ¶æŒ‰é’® -->
              <div class="flex justify-center items-center space-x-4">
                <button onclick="TimelineHandler.jumpToStart()" 
                        ${AppState.currentTimeIndex === 0 ? 'disabled' : ''}
                        class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-white text-sm">
                  â® é¦–å¸§
                </button>
                
                <button onclick="TimelineHandler.previous()" 
                        ${AppState.currentTimeIndex === 0 ? 'disabled' : ''}
                        class="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                  <span class="text-white text-xl">â—€</span>
                </button>
                
                <div class="px-4 py-2 bg-slate-800 rounded-lg">
                  <span class="text-cyan-400 font-mono text-sm frame-counter">
                    ${AppState.currentTimeIndex + 1} / ${AppState.timestamps.length}
                  </span>
                </div>
                
                <button onclick="TimelineHandler.next()"
                        ${AppState.currentTimeIndex >= AppState.timestamps.length - 1 ? 'disabled' : ''}
                        class="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                  <span class="text-white text-xl">â–¶</span>
                </button>
                
                <button onclick="TimelineHandler.jumpToEnd()" 
                        ${AppState.currentTimeIndex >= AppState.timestamps.length - 1 ? 'disabled' : ''}
                        class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-white text-sm">
                  æœ«å¸§ â­
                </button>
              </div>
            </div>
          </div>
        `;
      },
      
      generateTimeMarks() {
        const marks = [];
        const totalFrames = AppState.timestamps.length;
        const markCount = 8; // æ˜¾ç¤º8ä¸ªæ—¶é—´åˆ»åº¦
        
        for (let i = 0; i <= markCount; i++) {
          const index = Math.floor((i / markCount) * (totalFrames - 1));
          const timestamp = AppState.timestamps[index];
          if (timestamp) {
            marks.push(`<span class="text-xs text-gray-500">${Utils.formatTime(timestamp)}</span>`);
          }
        }
        
        return marks.join('');
      },

      renderPlaceholder(title, icon) {
        return `
          <div class="min-h-screen flex items-center justify-center fade-in">
            <div class="text-center">
              <div class="text-9xl mb-6">${icon}</div>
              <h2 class="text-4xl font-bold text-white mb-4">${title}</h2>
              <p class="text-gray-400 mb-8">è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
              <button onclick="Router.navigate('home')" 
                      class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                è¿”å›é¦–é¡µ
              </button>
            </div>
          </div>
        `;
      }
    };

    // ==================== æ—¥æœŸé€‰æ‹©å™¨å¤„ç†å™¨ ====================
    const DatePickerHandler = {
      toggle() {
        AppState.showDatePicker = !AppState.showDatePicker;
        const dropdown = document.getElementById('date-picker-dropdown');
        if (dropdown) {
          dropdown.classList.toggle('hidden');
        }
      },
      
      selectDate(date) {
        if (AppState.currentDate === date) {
          this.toggle();
          return;
        }
        
        AppState.currentDate = date;
        AppState.timestamps = AppState.dateTimestamps[date] || [];
        AppState.currentTimeIndex = 0;
        AppState.showDatePicker = false;
        
        Router.render();
      },
      
      close() {
        AppState.showDatePicker = false;
        const dropdown = document.getElementById('date-picker-dropdown');
        if (dropdown) {
          dropdown.classList.add('hidden');
        }
      }
    };

    // ==================== æ—¶é—´è½´å¤„ç†å™¨ ====================
    const TimelineHandler = {
      updateTimeout: null,
      
      previous() {
        AppState.currentTimeIndex = Math.max(0, AppState.currentTimeIndex - 1);
        this.updateDisplayImmediate();
      },

      next() {
        AppState.currentTimeIndex = Math.min(
          AppState.timestamps.length - 1, 
          AppState.currentTimeIndex + 1
        );
        this.updateDisplayImmediate();
      },

      jumpToStart() {
        AppState.currentTimeIndex = 0;
        this.updateDisplayImmediate();
      },

      jumpToEnd() {
        AppState.currentTimeIndex = AppState.timestamps.length - 1;
        this.updateDisplayImmediate();
      },

      onSliderStart() {
        AppState.isDragging = true;
      },

      onSliderMove(value) {
        // æ‹–åŠ¨è¿‡ç¨‹ä¸­åªæ›´æ–°UIé¢„è§ˆï¼Œä¸åŠ è½½æ•°æ®
        const newIndex = parseInt(value);
        AppState.pendingTimeIndex = newIndex;
        this.updateSliderUI(newIndex);
        this.updateTimePreview(newIndex);
      },

      onSliderEnd(value) {
        // æ¾å¼€åæ‰çœŸæ­£åŠ è½½æ•°æ®
        AppState.isDragging = false;
        const newIndex = parseInt(value);
        AppState.currentTimeIndex = newIndex;
        AppState.pendingTimeIndex = null;
        this.updateDisplayImmediate();
      },

      // ä»…æ›´æ–°æ»‘å—UIï¼ˆæ‹–åŠ¨ä¸­ï¼‰
      updateSliderUI(index) {
        const slider = document.getElementById('timeline-slider');
        if (slider && AppState.timestamps.length > 0) {
          const progress = (index / (AppState.timestamps.length - 1)) * 100;
          slider.style.background = `linear-gradient(to right, #06b6d4 ${progress}%, #334155 ${progress}%)`;
        }
      },

      // ä»…æ›´æ–°æ—¶é—´é¢„è§ˆï¼ˆæ‹–åŠ¨ä¸­ï¼‰
      updateTimePreview(index) {
        const currentTime = AppState.timestamps[index];
        document.querySelectorAll('.current-time-display').forEach(el => {
          el.textContent = Utils.formatTime(currentTime);
        });
        document.querySelectorAll('.frame-counter').forEach(el => {
          el.textContent = `${index + 1} / ${AppState.timestamps.length}`;
        });
      },

      // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºï¼ˆæ¾å¼€å/ç‚¹å‡»æŒ‰é’®ï¼‰- ä¼˜åŒ–ç‰ˆ
      updateDisplayImmediate() {
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];
        
        // 1. ç«‹å³æ›´æ–°UIå…ƒç´ ï¼ˆæ— å»¶è¿Ÿï¼‰
        const slider = document.getElementById('timeline-slider');
        if (slider) {
          slider.value = AppState.currentTimeIndex;
          this.updateSliderUI(AppState.currentTimeIndex);
        }
        this.updateTimePreview(AppState.currentTimeIndex);
        this.updateButtonStates();

        // 2. æ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœæœ‰ç¼“å­˜ç›´æ¥ä½¿ç”¨
        const cachedData = AppState.dataCache.get(currentTime);
        if (cachedData) {
          this.applyDeviceCardData(cachedData);
          if (AppState.activeDetailId !== null) {
            DeviceHandler.updateDetailContent(AppState.activeDetailId);
          }
          return;
        }

        // 3. æ— ç¼“å­˜æ—¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        Utils.showLoading('åŠ è½½æ•°æ®...');

        // 4. ä½¿ç”¨ setTimeout åˆ†æ‰¹åŠ è½½ï¼Œé¿å…é˜»å¡UI
        setTimeout(() => {
          const deviceCardData = {};
          
          // é¢„å…ˆè®¡ç®—æ‰€æœ‰è®¾å¤‡çš„æ•°æ®
          AppState.devicesData.forEach(device => {
            const firstParam = Object.values(device.parameters)[0];
            if (firstParam) {
              const valueData = this.findValueAtTime(firstParam, currentTime);
              deviceCardData[device.id] = {
                value: valueData.value,
                unit: firstParam.unit
              };
            }
          });
          
          // ç¼“å­˜æ•°æ®
          AppState.dataCache.set(currentTime, deviceCardData);
          
          // åº”ç”¨æ•°æ®
          this.applyDeviceCardData(deviceCardData);
          
          // æ›´æ–°è¯¦æƒ…çª—å£
          if (AppState.activeDetailId !== null) {
            DeviceHandler.updateDetailContent(AppState.activeDetailId);
          }
          
          // éšè—åŠ è½½åŠ¨ç”»
          Utils.hideLoading();
        }, 50); // 50mså»¶è¿Ÿï¼Œè®©UIå…ˆæ›´æ–°
      },

      // åº”ç”¨è®¾å¤‡å¡ç‰‡æ•°æ®ï¼ˆä¼˜åŒ–åçš„æ‰¹é‡æ›´æ–°ï¼‰
      applyDeviceCardData(deviceCardData) {
        const cards = document.querySelectorAll('.device-card');
        const fragment = document.createDocumentFragment();
        
        cards.forEach((card, idx) => {
          const valueEl = card.querySelector('.device-preview-value');
          if (valueEl && deviceCardData[idx]) {
            const data = deviceCardData[idx];
            const displayValue = Utils.isErrorValue(data.value) 
              ? 'ERROR' 
              : `${data.value} ${data.unit}`;
            valueEl.textContent = displayValue;
          }
        });
      },

      // æ›´æ–°æŒ‰é’®ç¦ç”¨çŠ¶æ€
      updateButtonStates() {
        const isFirst = AppState.currentTimeIndex === 0;
        const isLast = AppState.currentTimeIndex >= AppState.timestamps.length - 1;

        // æ›´æ–°é¦–å¸§/ä¸Šä¸€å¸§æŒ‰é’®
        document.querySelectorAll('button[onclick*="jumpToStart"], button[onclick*="previous"]').forEach(btn => {
          if (isFirst) {
            btn.setAttribute('disabled', 'disabled');
            btn.classList.add('opacity-30', 'cursor-not-allowed');
          } else {
            btn.removeAttribute('disabled');
            btn.classList.remove('opacity-30', 'cursor-not-allowed');
          }
        });

        // æ›´æ–°æœ«å¸§/ä¸‹ä¸€å¸§æŒ‰é’®
        document.querySelectorAll('button[onclick*="jumpToEnd"], button[onclick*="next"]').forEach(btn => {
          if (isLast) {
            btn.setAttribute('disabled', 'disabled');
            btn.classList.add('opacity-30', 'cursor-not-allowed');
          } else {
            btn.removeAttribute('disabled');
            btn.classList.remove('opacity-30', 'cursor-not-allowed');
          }
        });
      },
      
      // æŸ¥æ‰¾æŒ‡å®šæ—¶é—´ç‚¹çš„å‚æ•°å€¼ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼‰
      findValueAtTime(param, targetTime) {
        if (!param || !param.values || param.values.length === 0) {
          return { value: '--', raw: '--' };
        }
        
        // ç²¾ç¡®åŒ¹é…
        let valueData = param.values.find(v => v.timestamp === targetTime);
        
        // å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…ï¼Œæ‰¾æœ€è¿‘çš„ï¼ˆä¼˜åŒ–ï¼šåªæŸ¥æ‰¾é‚»è¿‘çš„å‡ ä¸ªï¼‰
        if (!valueData && param.values.length > 0) {
          // ç®€åŒ–ï¼šå–ç¬¬ä¸€ä¸ªåŒ¹é…çš„æˆ–è€…æœ€åä¸€ä¸ª
          valueData = param.values[0];
        }
        
        return valueData || { value: '--', raw: '--' };
      }
    };

    // ==================== è®¾å¤‡äº¤äº’å¤„ç†å™¨ ====================
    const DeviceHandler = {
      toggleDetail(deviceId, event) {
        event.stopPropagation();
        
        const existingModal = document.getElementById('device-detail-modal');
        if (existingModal) {
          if (AppState.activeDetailId === deviceId) {
            existingModal.remove();
            AppState.activeDetailId = null;
            return;
          }
          existingModal.remove();
        }

        AppState.activeDetailId = deviceId;
        const device = AppState.devicesData.find(d => d.id === deviceId);
        if (!device) return;

        const modal = document.createElement('div');
        modal.id = 'device-detail-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.remove();
            AppState.activeDetailId = null;
          }
        };

        const content = document.createElement('div');
        content.className = 'bg-slate-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-y-auto slide-up';
        content.onclick = (e) => e.stopPropagation();
        
        this.renderDetailContent(content, device);
        
        modal.appendChild(content);
        document.body.appendChild(modal);
      },

      renderDetailContent(container, device) {
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];
        const paramEntries = Object.entries(device.parameters);
        
        // æŒ‰å‚æ•°åˆ†ç±»
        const categories = {
          'ç”µå‹å‚æ•°': [],
          'ç”µæµå‚æ•°': [],
          'åŠŸç‡å‚æ•°': [],
          'é€Ÿåº¦/è½¬é€Ÿ': [],
          'å…¶ä»–å‚æ•°': []
        };
        
        paramEntries.forEach(([key, param]) => {
          if (param.displayName.includes('ç”µå‹')) {
            categories['ç”µå‹å‚æ•°'].push([key, param]);
          } else if (param.displayName.includes('ç”µæµ')) {
            categories['ç”µæµå‚æ•°'].push([key, param]);
          } else if (param.displayName.includes('åŠŸç‡')) {
            categories['åŠŸç‡å‚æ•°'].push([key, param]);
          } else if (param.displayName.includes('è½¬é€Ÿ') || param.displayName.includes('é€Ÿåº¦')) {
            categories['é€Ÿåº¦/è½¬é€Ÿ'].push([key, param]);
          } else {
            categories['å…¶ä»–å‚æ•°'].push([key, param]);
          }
        });
        
        container.innerHTML = `
          <div class="p-6">
            <!-- å¤´éƒ¨ -->
            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
              <div class="flex items-center space-x-3">
                <span class="text-6xl">${device.icon}</span>
                <div>
                  <h3 class="text-3xl font-bold text-white">${device.name}</h3>
                  <p class="text-sm text-gray-400 mt-1">å®æ—¶è¿è¡Œå‚æ•°ç›‘æ§</p>
                </div>
              </div>
              <button onclick="document.getElementById('device-detail-modal').remove(); AppState.activeDetailId = null;" 
                      class="text-gray-400 hover:text-white text-4xl leading-none p-2 transition-colors">
                Ã—
              </button>
            </div>
            
            <!-- æ—¶é—´æ˜¾ç¤º -->
            <div class="mb-6 bg-slate-700/50 rounded-lg p-4 flex justify-between items-center">
              <div>
                <span class="text-gray-400 text-sm">å½“å‰æ—¶é—´ç‚¹</span>
                <div class="text-cyan-400 font-mono text-xl mt-1">${currentTime || '--'}</div>
              </div>
              <div class="text-right">
                <span class="text-gray-400 text-sm">å‚æ•°æ•°é‡</span>
                <div class="text-white text-xl font-bold mt-1">${paramEntries.length} é¡¹</div>
              </div>
            </div>
            
            <!-- å‚æ•°åˆ†ç±»æ˜¾ç¤º -->
            ${Object.entries(categories).filter(([cat, items]) => items.length > 0).map(([category, items]) => `
              <div class="mb-6">
                <h4 class="text-lg font-bold text-cyan-400 mb-3 flex items-center">
                  <span class="w-1 h-6 bg-cyan-400 mr-2"></span>
                  ${category}
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  ${items.map(([key, param]) => {
                    const valueData = TimelineHandler.findValueAtTime(param, currentTime);
                    const isError = Utils.isErrorValue(valueData.value);
                    const displayValue = isError ? 'ERROR' : valueData.value;
                    const status = Utils.getValueStatus(valueData.value, FieldMapping[key]);
                    
                    return `
                      <div class="bg-slate-700/50 rounded-lg p-4 hover:bg-slate-700/70 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                          <span class="text-gray-300 text-sm font-medium">${param.displayName}</span>
                          <span class="param-badge ${isError ? 'badge-error' : 'badge-normal'}">
                            ${isError ? 'ERR' : 'OK'}
                          </span>
                        </div>
                        <div class="flex items-end justify-between">
                          <div class="text-2xl font-bold ${isError ? 'text-red-400' : 'text-white'}">
                            ${displayValue}
                          </div>
                          <div class="text-gray-400 text-sm">${param.unit}</div>
                        </div>
                        ${!isError && parseFloat(displayValue) ? `
                          <div class="mt-2 w-full bg-slate-600 rounded-full h-1.5">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-1.5 rounded-full transition-all duration-300" 
                                 style="width: ${Math.min(Math.abs(parseFloat(displayValue) / 100), 1) * 100}%"></div>
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `).join('')}
            
            <!-- åº•éƒ¨æç¤º -->
            <div class="mt-6 pt-4 border-t border-slate-700 text-center text-sm text-gray-400">
              <p>ğŸ’¡ æ‹–åŠ¨æ—¶é—´è½´å¯æŸ¥çœ‹å†å²æ•°æ® | æ•°æ®è‡ªåŠ¨åŒæ­¥æ›´æ–°</p>
            </div>
          </div>
        `;
      },

      updateDetailContent(deviceId) {
        const modal = document.getElementById('device-detail-modal');
        if (!modal) return;

        const device = AppState.devicesData.find(d => d.id === deviceId);
        if (!device) return;

        const content = modal.querySelector('.bg-slate-800');
        if (content) {
          this.renderDetailContent(content, device);
        }
      }
    };

    // ==================== è·¯ç”±ç®¡ç† ====================
    const Router = {
      async navigate(page) {
        AppState.currentPage = page;
        await this.render();
      },

      async render() {
        const app = document.getElementById('app');
        let html = '';

        switch (AppState.currentPage) {
          case 'home':
            html = Pages.renderHome();
            break;
          case 'monitor':
            // å¦‚æœæ•°æ®æœªåŠ è½½ï¼Œå…ˆåŠ è½½
            if (Object.keys(AppState.devicesData).length === 0) {
              html = await Pages.renderMonitor();
              app.innerHTML = html;
              await DataManager.loadAllData();
              html = await Pages.renderMonitor();
              app.innerHTML = html;
              // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
              setTimeout(() => TimelineHandler.updateButtonStates(), 100);
              return;
            }
            html = await Pages.renderMonitor();
            // æ¸²æŸ“åæ›´æ–°æŒ‰é’®çŠ¶æ€
            app.innerHTML = html;
            setTimeout(() => TimelineHandler.updateButtonStates(), 100);
            break;
          case 'reports':
            html = Pages.renderPlaceholder('æŠ¥è¡¨ç»Ÿè®¡', 'ğŸ“‹');
            break;
          case 'settings':
            html = Pages.renderPlaceholder('ç³»ç»Ÿè®¾ç½®', 'âš™ï¸');
            break;
          case 'alerts':
            html = Pages.renderPlaceholder('æŠ¥è­¦ç®¡ç†', 'ğŸ””');
            break;
          default:
            html = Pages.renderHome();
        }

        app.innerHTML = html;
      }
    };

    // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
    window.addEventListener('DOMContentLoaded', () => {
      Router.render();
      
      // ç‚¹å‡»å¤–éƒ¨å…³é—­æ—¥æœŸé€‰æ‹©å™¨
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('date-picker-dropdown');
        const button = e.target.closest('button[onclick*="DatePickerHandler.toggle"]');
        if (dropdown && !dropdown.contains(e.target) && !button) {
          DatePickerHandler.close();
        }
      });
    });
  </script>
</body>
</html>