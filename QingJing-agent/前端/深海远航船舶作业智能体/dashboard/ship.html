<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èˆ¹èˆ¶è®¾å¤‡ç›‘æ§ç³»ç»Ÿ</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse CDN (CSVè§£æ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    .loading-spinner {
      animation: spin 1s linear infinite;
    }

    .loading-pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }

    .menu-card {
      transition: all 0.3s ease;
    }

    .menu-card:hover {
      transform: translateY(-10px) scale(1.05);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .device-card {
      transition: all 0.3s ease;
    }

    .device-card:hover {
      transform: scale(1.05);
    }

    .device-detail {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* åŠ è½½é®ç½© */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-track {
      background: #334155;
      height: 8px;
      border-radius: 4px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #06b6d4;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.5);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      background: #0891b2;
      transform: scale(1.2);
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .param-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-normal {
      background: #22c55e;
      color: white;
    }

    .badge-warning {
      background: #eab308;
      color: white;
    }

    .badge-error {
      background: #ef4444;
      color: white;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 min-h-screen">
  <!-- è¿”å›æ ¸å¿ƒåŠŸèƒ½æŒ‰é’® -->
  <a href="../function.html" class="fixed top-4 left-4 z-50 inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-cyan-400/40 
            text-cyan-200 bg-slate-800/70 hover:bg-slate-700/80 hover:text-white shadow-lg backdrop-blur"
    title="è¿”å›æ ¸å¿ƒåŠŸèƒ½">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      class="w-5 h-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
    <span class="hidden sm:inline">è¿”å›æ ¸å¿ƒåŠŸèƒ½</span>
  </a>

  <div id="app"></div>

  <script>
    // ==================== å­—æ®µæ˜ å°„è¡¨ ====================
    const FieldMapping = {
      // Aæ¶è®¾å¤‡
      'Ajia-0_v': { name: 'Aæ¶å³èˆ·è§’åº¦', unit: 'Â°', device: 'Aæ¶' },
      'Ajia-1_v': { name: 'Aæ¶å·¦èˆ·è§’åº¦', unit: 'Â°', device: 'Aæ¶' },
      'Ajia-2_v': { name: '1å¯åŠ¨æŸœç”µå‹', unit: 'V', device: 'Aæ¶' },
      'Ajia-3_v': { name: '1å¯åŠ¨æŸœç”µæµ', unit: 'A', device: 'Aæ¶' },
      'Ajia-4_v': { name: '2å¯åŠ¨æŸœç”µå‹', unit: 'V', device: 'Aæ¶' },
      'Ajia-5_v': { name: '2å¯åŠ¨æŸœç”µæµ', unit: 'A', device: 'Aæ¶' },

      // ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ
      '1-5-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '1-5-1_v': { name: 'Ubç”µå‹', unit: 'V', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '1-5-2_v': { name: 'Ucç”µå‹', unit: 'V', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '1-5-3_v': { name: 'Iaç”µæµ', unit: 'A', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-4_v': { name: 'Ibç”µæµ', unit: 'A', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-5_v': { name: 'Icç”µæµ', unit: 'A', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '1-5-10_v': { name: 'é¢‘ç‡', unit: 'Hz', device: 'ä¸€å·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.01 },

      // äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ
      '13-14-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '13-14-1_v': { name: 'Ubç”µå‹', unit: 'V', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '13-14-2_v': { name: 'Ucç”µå‹', unit: 'V', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.1 },
      '13-14-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ' },
      '13-14-10_v': { name: 'é¢‘ç‡', unit: 'Hz', device: 'äºŒå·é—¨æ¶ä¸»æ¶²å‹æ³µ', scale: 0.01 },

      // ç»è½¦
      'PLC_point0_value': { name: 'ç»è½¦Aæ”¾ç¼†é•¿åº¦', unit: 'm', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point1_value': { name: 'ç»è½¦Aæ”¾ç¼†é€Ÿåº¦', unit: 'm/s', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point2_value': { name: 'ç»è½¦Aå¼ åŠ›', unit: 'kN', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point3_value': { name: 'ç»è½¦Bæ”¾ç¼†é•¿åº¦', unit: 'm', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point4_value': { name: 'ç»è½¦Bæ”¾ç¼†é€Ÿåº¦', unit: 'm/s', device: 'ç»è½¦ç³»ç»Ÿ' },
      'PLC_point5_value': { name: 'ç»è½¦Bå¼ åŠ›', unit: 'kN', device: 'ç»è½¦ç³»ç»Ÿ' },

      // ç»è½¦å˜é¢‘å™¨
      '1-15-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ç»è½¦å˜é¢‘å™¨', scale: 0.1 },
      '1-15-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ç»è½¦å˜é¢‘å™¨' },
      '1-15-10_v': { name: 'é¢‘ç‡', unit: 'Hz', device: 'ç»è½¦å˜é¢‘å™¨', scale: 0.01 },

      // æŠ˜è‡‚åŠè½¦
      '13-11-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'æŠ˜è‡‚åŠè½¦æ¶²å‹', scale: 0.1 },
      '13-11-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'æŠ˜è‡‚åŠè½¦æ¶²å‹' },

      // å‘ç”µæœºç»„
      'P1_2': { name: 'è½¬é€Ÿ', unit: 'RPM', device: 'ä¸€å·æŸ´æ²¹å‘ç”µæœº' },
      'P1_3': { name: 'ç‡ƒæ²¹æ¶ˆè€—ç‡', unit: 'L/h', device: 'ä¸€å·æŸ´æ²¹å‘ç”µæœº' },
      'P1_66': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·æŸ´æ²¹å‘ç”µæœº' },
      'P1_24': { name: 'è½¬é€Ÿ', unit: 'RPM', device: 'äºŒå·æŸ´æ²¹å‘ç”µæœº' },
      'P1_25': { name: 'ç‡ƒæ²¹æ¶ˆè€—ç‡', unit: 'L/h', device: 'äºŒå·æŸ´æ²¹å‘ç”µæœº' },
      'P1_75': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'äºŒå·æŸ´æ²¹å‘ç”µæœº' },
      'P2_2': { name: 'è½¬é€Ÿ', unit: 'RPM', device: 'ä¸‰å·æŸ´æ²¹å‘ç”µæœº' },
      'P2_3': { name: 'ç‡ƒæ²¹æ¶ˆè€—ç‡', unit: 'L/h', device: 'ä¸‰å·æŸ´æ²¹å‘ç”µæœº' },
      'P2_51': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸‰å·æŸ´æ²¹å‘ç”µæœº' },

      // èˆµæ¡¨
      '1-2-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµA', scale: 0.1 },
      '1-2-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµA' },
      '1-3-0_v': { name: 'Uaç”µå‹', unit: 'V', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµB', scale: 0.1 },
      '1-3-6_v': { name: 'æœ‰åŠŸåŠŸç‡', unit: 'kW', device: 'ä¸€å·èˆµæ¡¨è½¬èˆµB' },
      'P3_19': { name: 'æ–¹ä½å‘½ä»¤', unit: '%', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },
      'P3_20': { name: 'æ–¹ä½åé¦ˆ', unit: '%', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },
      'P3_21': { name: 'è½¬é€Ÿå‘½ä»¤', unit: 'RPM', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },
      'P3_22': { name: 'è½¬é€Ÿåé¦ˆ', unit: 'RPM', device: 'ä¸€å·èˆµæ¡¨æ§åˆ¶' },

      // æ¨è¿›å™¨
      'P3_15': { name: 'åŠŸç‡åé¦ˆ', unit: 'kW', device: 'ä¸€å·æ¨è¿›å˜é¢‘å™¨' },
      'P3_32': { name: 'åŠŸç‡å…è®¸', unit: 'kW', device: 'ä¸€å·æ¨è¿›å˜é¢‘å™¨' },
      'P4_15': { name: 'åŠŸç‡å…è®¸', unit: 'kW', device: 'äºŒå·æ¨è¿›å˜é¢‘å™¨' },
      'P4_16': { name: 'åŠŸç‡åé¦ˆ', unit: 'kW', device: 'äºŒå·æ¨è¿›å˜é¢‘å™¨' },
      'P3_18': { name: 'åŠŸç‡åé¦ˆ', unit: 'kW', device: 'è‰æ¨' },
      'P1_80': { name: 'ä¸»å¼€å…³ç”µæµ', unit: 'A', device: 'è‰æ¨' },
    };

    // ==================== æ–‡ä»¶åˆ—è¡¨ ====================
    const CSV_FILES = [
      'Ajia_plc_1.csv',
      'device_1_2_meter_102.csv',
      'device_1_3_meter_103.csv',
      'device_1_5_meter_105.csv',
      'device_1_15_meter_115.csv',
      'device_13_2_meter_1302.csv',
      'device_13_3_meter_1303.csv',
      'device_13_11_meter_1311.csv',
      'device_13_14_meter_1314.csv',
      'Jiaoche_plc_1.csv',
      'Port1_ksbg_1.csv',
      'Port1_ksbg_2.csv',
      'Port1_ksbg_3.csv',
      'Port1_ksbg_4.csv',
      'Port1_ksbg_5.csv',
      'Port2_ksbg_1.csv',
      'Port2_ksbg_2.csv',
      'Port2_ksbg_3.csv',
      'Port2_ksbg_4.csv',
      'Port3_ksbg_8.csv',
      'Port3_ksbg_9.csv',
      'Port3_ksbg_10.csv',
      'Port4_ksbg_7.csv',
      'Port4_ksbg_8.csv',
      'Port4_ksbg_9.csv'
    ];

    // ==================== å…¨å±€çŠ¶æ€ ====================
    const AppState = {
      currentPage: 'home',
      currentTimeIndex: 0,
      currentDate: null,           // å½“å‰é€‰ä¸­çš„æ—¥æœŸ
      availableDates: [],          // å¯ç”¨çš„æ—¥æœŸåˆ—è¡¨
      dateTimestamps: {},          // æŒ‰æ—¥æœŸåˆ†ç»„çš„æ—¶é—´æˆ³ { '2024-05-17': [...timestamps] }
      dateTimestampsOriginal: {},  // åŸå§‹å®Œæ•´æ—¶é—´æˆ³ï¼ˆæœªé‡‡æ ·ï¼‰
      timestamps: [],              // å½“å‰æ—¥æœŸçš„æ—¶é—´æˆ³ï¼ˆé‡‡æ ·åï¼‰
      devicesData: {},
      activeDetailId: null,
      loadingProgress: 0,
      showDatePicker: false,       // æ˜¯å¦æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
      samplingRate: 100,           // æ¯æ—¥é‡‡æ ·å¸§æ•°
      isDragging: false,           // æ˜¯å¦æ­£åœ¨æ‹–åŠ¨æ—¶é—´è½´
      pendingTimeIndex: null,      // å¾…æ›´æ–°çš„æ—¶é—´ç´¢å¼•ï¼ˆæ‹–åŠ¨ä¸­ï¼‰
      dataCache: new Map(),        // æ•°æ®ç¼“å­˜ { timestamp: { deviceId: values } }
      alertsCache: new Map()       // æŠ¥è­¦ç¼“å­˜ { date: { deviceId: Alarm[] } }
    };

    // ==================== å·¥å…·å‡½æ•° ====================
    const Utils = {
      // å°†æ—¶é—´æˆ³ç²¾ç¡®åˆ°â€œåˆ†é’Ÿâ€ï¼ˆè¿”å›æ ¼å¼ï¼šYYYY-MM-DD HH:MMï¼‰
      toMinuteKey(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return null;
        const parts = timeStr.split(' ');
        if (parts.length < 2) return timeStr;
        const date = parts[0];
        const time = parts[1];
        const tparts = time.split(':');
        if (tparts.length < 2) return `${date} ${time}`;
        // ä»…ä¿ç•™åˆ°åˆ†é’Ÿ
        const hh = tparts[0];
        const mm = tparts[1];
        return `${date} ${hh}:${mm}`;
      },
      formatTime(timeStr) {
        if (!timeStr) return '--:--';
        const parts = timeStr.split(' ');
        const t = parts.length > 1 ? parts[1] : timeStr;
        // æœŸæœ› timeStr å·²æ˜¯åˆ°åˆ†é’Ÿçš„é”®ï¼Œä»ç„¶é˜²å¾¡æ€§æˆªæ–­åˆ° HH:MM
        const tp = t.split(':');
        if (tp.length >= 2) return `${tp[0]}:${tp[1]}`;
        return t;
      },

      formatDate(timeStr) {
        if (!timeStr) return '--';
        const parts = timeStr.split(' ');
        return parts.length > 0 ? parts[0] : timeStr;
      },

      getDateFromTimestamp(timeStr) {
        if (!timeStr) return null;
        const parts = timeStr.split(' ');
        return parts.length > 0 ? parts[0] : null;
      },

      // é‡‡æ ·å‡½æ•°ï¼šä»æ•°ç»„ä¸­å‡åŒ€é‡‡æ ·æŒ‡å®šæ•°é‡çš„å…ƒç´ 
      sampleArray(array, sampleCount) {
        if (!array || array.length === 0) return [];
        if (array.length <= sampleCount) return [...array];

        const samples = [];
        const totalCount = array.length;

        // æŒ‰100åˆ†ç‚¹é‡‡æ ·
        for (let i = 0; i < sampleCount; i++) {
          const index = Math.floor((i / (sampleCount - 1)) * (totalCount - 1));
          samples.push(array[index]);
        }

        return samples;
      },

      getDeviceIcon(name) {
        if (name.includes('Aæ¶')) return 'ğŸ—ï¸';
        if (name.includes('é—¨æ¶')) return 'ğŸ—ï¸';
        if (name.includes('ç»è½¦')) return 'âš™ï¸';
        if (name.includes('åŠè½¦')) return 'ğŸšœ';
        if (name.includes('èˆµæ¡¨')) return 'ğŸš¢';
        if (name.includes('æ¨è¿›') || name.includes('è‰æ¨')) return 'âš“';
        if (name.includes('å‘ç”µæœº')) return 'âš¡';
        return 'ğŸ“¦';
      },

      createElement(tag, className = '', innerHTML = '') {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (innerHTML) el.innerHTML = innerHTML;
        return el;
      },

      applyScale(value, scale) {
        if (!scale || scale === 1) return value;
        const num = parseFloat(value);
        return isNaN(num) ? value : (num * scale).toFixed(2);
      },

      isErrorValue(value) {
        return value === 'error' || value === null || value === undefined || value === '';
      },

      getValueStatus(value, mapping) {
        if (Utils.isErrorValue(value)) return 'error';
        const num = parseFloat(value);
        if (isNaN(num)) return 'normal';
        // å¯ä»¥æ ¹æ®mappingä¸­çš„é˜ˆå€¼åˆ¤æ–­ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        return 'normal';
      },

      // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
      showLoading(message = 'åŠ è½½ä¸­...') {
        let overlay = document.getElementById('loading-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'loading-overlay';
          overlay.className = 'loading-overlay';
          overlay.innerHTML = `
            <div class="bg-slate-800 rounded-xl p-6 shadow-2xl border border-slate-700">
              <div class="flex items-center space-x-4">
                <div class="loading-spinner w-8 h-8 border-4 border-cyan-400 border-t-transparent rounded-full"></div>
                <span class="text-white text-lg">${message}</span>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);
        }
        // å¼ºåˆ¶é‡ç»˜
        overlay.offsetHeight;
        overlay.classList.add('active');
      },

      // éšè—åŠ è½½åŠ¨ç”»
      hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.remove('active');
        }
      }
    };

    // ==================== æ•°æ®åŠ è½½å™¨ ====================
    const DataManager = {
      alarmRules: null, // { keyword: { low, high, unit } }

      async loadAllData() {
        try {
          AppState.loadingProgress = 0;
          const totalFiles = CSV_FILES.length;
          let loadedFiles = 0;

          // å¹¶è¡ŒåŠ è½½æ‰€æœ‰CSVæ–‡ä»¶
          const promises = CSV_FILES.map(async (filename) => {
            try {
              const response = await fetch(`./data/${filename}`);
              if (!response.ok) {
                console.warn(`æ–‡ä»¶åŠ è½½å¤±è´¥: ${filename}`);
                return null;
              }
              const text = await response.text();

              return new Promise((resolve) => {
                Papa.parse(text, {
                  header: true,
                  skipEmptyLines: true,
                  complete: (results) => {
                    loadedFiles++;
                    AppState.loadingProgress = Math.round((loadedFiles / totalFiles) * 100);
                    this.updateLoadingUI();
                    resolve({ filename, data: results.data });
                  },
                  error: (error) => {
                    console.error(`è§£æå¤±è´¥: ${filename}`, error);
                    resolve(null);
                  }
                });
              });
            } catch (error) {
              console.error(`è¯»å–æ–‡ä»¶é”™è¯¯: ${filename}`, error);
              return null;
            }
          });

          const results = await Promise.all(promises);

          // ç»„ç»‡æ•°æ®ï¼šæŒ‰è®¾å¤‡åˆ†ç»„
          this.organizeDataByDevice(results.filter(r => r !== null));

          // å¹¶è¡ŒåŠ è½½æŠ¥è­¦è§„åˆ™
          await this.loadAlarmRules();

          return true;
        } catch (error) {
          console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
          return false;
        }
      },

      async loadAlarmRules() {
        if (this.alarmRules) return this.alarmRules;
        try {
          const resp = await fetch('./data/è®¾å¤‡å‚æ•°è¯¦æƒ….csv');
          if (!resp.ok) throw new Error('è®¾å¤‡å‚æ•°è¯¦æƒ….csv åŠ è½½å¤±è´¥');
          const text = await resp.text();
          return new Promise((resolve) => {
            Papa.parse(text, {
              header: true,
              skipEmptyLines: true,
              complete: (results) => {
                const rules = {};
                const keywords = [
                  'æœ‰åŠŸåŠŸç‡', 'é¢‘ç‡', 'è½¬é€Ÿ', 'ç‡ƒæ²¹æ¶ˆè€—ç‡', 'è“„ç”µæ± ç”µå‹', 'ç”µå‹', 'ç”µæµ', 'æ¸©åº¦', 'å‹åŠ›', 'æ¶²ä½'
                ];
                results.data.forEach(row => {
                  const cn = row.Channel_Text_CN || '';
                  const low = parseFloat(row.Alarm_Information_Range_Low);
                  const high = parseFloat(row.Alarm_Information_Range_High);
                  const unit = row.Alarm_Information_Unit || '';
                  if (!isFinite(low) && !isFinite(high)) return;
                  const kw = keywords.find(k => cn.includes(k));
                  if (!kw) return;
                  // è‹¥åŒä¸€å…³é”®è¯å¤šæ¬¡å‡ºç°ï¼Œä¼˜å…ˆä¿ç•™å·²å­˜åœ¨çš„ï¼ˆé¿å…è¢«éå…¸å‹é¡¹è¦†ç›–ï¼‰
                  if (!rules[kw]) {
                    rules[kw] = { low: isFinite(low) ? low : null, high: isFinite(high) ? high : null, unit };
                  }
                });
                this.alarmRules = rules;
                resolve(rules);
              },
              error: () => resolve({})
            });
          });
        } catch (e) {
          console.warn('æŠ¥è­¦è§„åˆ™åŠ è½½å¤±è´¥:', e);
          this.alarmRules = {};
          return this.alarmRules;
        }
      },

      // æ ¹æ®å‚æ•°åæ˜ å°„åˆ°è§„åˆ™å…³é”®è¯
      getKeywordForParamName(name) {
        if (!name) return null;
        const map = [
          { k: 'æœ‰åŠŸåŠŸç‡', match: ['æœ‰åŠŸåŠŸç‡', 'åŠŸç‡åé¦ˆ'] },
          { k: 'é¢‘ç‡', match: ['é¢‘ç‡'] },
          { k: 'è½¬é€Ÿ', match: ['è½¬é€Ÿ'] },
          { k: 'ç‡ƒæ²¹æ¶ˆè€—ç‡', match: ['ç‡ƒæ²¹æ¶ˆè€—ç‡'] },
          { k: 'è“„ç”µæ± ç”µå‹', match: ['è“„ç”µæ± ç”µå‹'] },
          { k: 'ç”µå‹', match: ['ç”µå‹', 'Uaç”µå‹', 'Ubç”µå‹', 'Ucç”µå‹'] },
          { k: 'ç”µæµ', match: ['ç”µæµ'] },
          { k: 'æ¸©åº¦', match: ['æ¸©åº¦'] },
          { k: 'å‹åŠ›', match: ['å‹åŠ›'] },
          { k: 'æ¶²ä½', match: ['æ¶²ä½'] }
        ];
        for (const item of map) {
          if (item.match.some(m => name.includes(m))) return item.k;
        }
        return null;
      },

      async getOrBuildDailyAlarms(date) {
        if (!date) return {};
        const cached = AppState.alertsCache.get(date);
        if (cached) return cached;

        // ç¡®ä¿è§„åˆ™åŠ è½½
        await this.loadAlarmRules();
        const rules = this.alarmRules || {};
        const minutes = (AppState.dateTimestampsOriginal && AppState.dateTimestampsOriginal[date]) || [];
        const results = {}; // deviceId -> Alarm[]

        AppState.devicesData.forEach(device => {
          const deviceAlarms = [];
          // éå†è¯¥è®¾å¤‡ä¸‹çš„æ‰€æœ‰å‚æ•°
          Object.values(device.parameters).forEach(param => {
            const kw = this.getKeywordForParamName(param.displayName);
            const rule = kw ? rules[kw] : null;
            if (!rule) return;
            const { low, high } = rule;
            // éå†åˆ†é’Ÿ
            minutes.forEach(ts => {
              const rec = param.valuesByTimestamp && param.valuesByTimestamp[ts];
              if (!rec) return;
              const val = parseFloat(rec.value);
              if (!isFinite(val)) return;
              let out = false;
              if (low != null && val < low) out = true;
              if (high != null && val > high) out = true;
              if (out) {
                deviceAlarms.push({
                  minute: ts,
                  paramName: param.displayName,
                  value: val,
                  unit: param.unit || '',
                  low, high
                });
              }
            });
          });
          // æŒ‰æ—¶é—´æ’åº
          deviceAlarms.sort((a, b) => (a.minute < b.minute ? -1 : a.minute > b.minute ? 1 : 0));
          results[device.id] = deviceAlarms;
        });

        AppState.alertsCache.set(date, results);
        return results;
      },

      organizeDataByDevice(fileResults) {
        const deviceMap = {};
        const dateTimestamps = {};

        // ç¬¬ä¸€éï¼šæ”¶é›†æ—¶é—´æˆ³å¹¶æŠŠæ•°æ®æŒ‰å­—æ®µæŒ‰æ—¶é—´æˆ³å­˜å…¥ä¸´æ—¶æ˜ å°„ï¼ˆvaluesByTimestampï¼‰
        fileResults.forEach(({ filename, data }) => {
          if (!data || data.length === 0) return;

          data.forEach(row => {
            const minuteKey = row.csvTime ? Utils.toMinuteKey(row.csvTime) : null;
            if (minuteKey) {
              const date = Utils.getDateFromTimestamp(minuteKey);
              if (date) {
                if (!dateTimestamps[date]) dateTimestamps[date] = [];
                dateTimestamps[date].push(minuteKey);
              }
            }

            Object.keys(row).forEach(fieldKey => {
              if (fieldKey === 'csvTime' || fieldKey === '' || fieldKey === '_id') return;

              const mapping = FieldMapping[fieldKey];
              if (!mapping) return;

              const deviceName = mapping.device;
              if (!deviceMap[deviceName]) {
                deviceMap[deviceName] = {
                  name: deviceName,
                  icon: Utils.getDeviceIcon(deviceName),
                  parameters: {}
                };
              }

              if (!deviceMap[deviceName].parameters[fieldKey]) {
                deviceMap[deviceName].parameters[fieldKey] = {
                  displayName: mapping.name,
                  unit: mapping.unit || '',
                  scale: mapping.scale || 1,
                  // ä½¿ç”¨ map å­˜å‚¨åŸå§‹æŒ‰æ—¶é—´ç´¢å¼•çš„æ•°æ®ï¼Œä¾¿äºä¹‹åæŒ‰é‡‡æ ·æ—¶é—´ç‚¹é‡å»º
                  valuesByTimestamp: {}
                };
              }

              const rawValue = row[fieldKey];
              const scaledValue = mapping.scale ? Utils.applyScale(rawValue, mapping.scale) : rawValue;

              // è®°å½•åˆ° valuesByTimestampï¼ˆå¦‚æœåŒä¸€ timestamp æœ‰å¤šä¸ªæ¥æºï¼Œåè€…è¦†ç›–å‰è€…ï¼‰
              if (minuteKey) {
                deviceMap[deviceName].parameters[fieldKey].valuesByTimestamp[minuteKey] = {
                  timestamp: minuteKey,
                  value: scaledValue,
                  raw: rawValue
                };
              }
            });
          });
        });

        // å»é‡å¹¶æ’åºæ¯ä¸ªæ—¥æœŸçš„æ—¶é—´æˆ³
        Object.keys(dateTimestamps).forEach(date => {
          dateTimestamps[date] = [...new Set(dateTimestamps[date])].sort();
        });

        // ä¿å­˜åŸå§‹å®Œæ•´æ•°æ®
        AppState.dateTimestampsOriginal = JSON.parse(JSON.stringify(dateTimestamps));

        // é‡‡æ ·ï¼šç›´æ¥ä¿ç•™ AppState.samplingRate å¸§ï¼ˆä¾‹å¦‚ 100ï¼‰ï¼Œä¸¢å¼ƒå…¶ä»–æ•°æ®
        const sampledDateTimestamps = {};
        Object.keys(dateTimestamps).forEach(date => {
          const originalFrames = dateTimestamps[date];
          const sampleCount = Math.min(AppState.samplingRate, originalFrames.length || 0);
          const sampledFrames = Utils.sampleArray(originalFrames, sampleCount);
          sampledDateTimestamps[date] = sampledFrames;
          console.log(`æ—¥æœŸ ${date}: åŸå§‹ ${originalFrames.length} å¸§ -> é‡‡æ · ${sampledFrames.length} å¸§`);
        });

        AppState.dateTimestamps = sampledDateTimestamps;
        AppState.availableDates = Object.keys(sampledDateTimestamps).sort();

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸æ—¶é—´æˆ³æ•°ç»„
        if (AppState.availableDates.length > 0) {
          AppState.currentDate = AppState.availableDates[0];
          AppState.timestamps = sampledDateTimestamps[AppState.currentDate] || [];
          AppState.currentTimeIndex = 0;
        }

        // æ ¹æ®é‡‡æ ·åçš„æ—¶é—´æˆ³é‡å»ºæ¯ä¸ªå‚æ•°çš„ values æ•°ç»„ï¼ˆåªä¿ç•™é‡‡æ ·å¸§çš„æ•°æ®ï¼‰
        const devicesData = [];
        let idx = 0;
        Object.values(deviceMap).forEach(device => {
          const params = {};
          Object.entries(device.parameters).forEach(([key, param]) => {
            const values = [];
            const sampledFramesForDate = AppState.timestamps || [];
            sampledFramesForDate.forEach(ts => {
              const v = param.valuesByTimestamp && param.valuesByTimestamp[ts];
              if (v) values.push(v);
              else values.push({ timestamp: ts, value: '--', raw: '--' });
            });

            params[key] = {
              displayName: param.displayName,
              unit: param.unit,
              scale: param.scale,
              values,
              // ä¿ç•™æ˜ å°„ä¾›åˆ‡æ¢æ—¥æœŸæ—¶é‡å»º
              valuesByTimestamp: param.valuesByTimestamp
            };
          });

          devicesData.push({
            id: idx,
            name: device.name,
            icon: device.icon,
            parameters: params
          });
          idx++;
        });

        AppState.devicesData = devicesData;

        // æš´éœ²ä¸€ä¸ªé‡å»ºæ–¹æ³•ï¼šåœ¨åˆ‡æ¢æ—¥æœŸæ—¶ç”¨å½“å‰ AppState.timestamps æŠ•å½±å„å‚æ•°å€¼
        this.projectValuesForCurrentDate = () => {
          const frames = AppState.timestamps || [];
          AppState.devicesData.forEach(device => {
            Object.values(device.parameters).forEach(param => {
              const arr = [];
              frames.forEach(ts => {
                const v = param.valuesByTimestamp && param.valuesByTimestamp[ts];
                if (v) arr.push(v);
                else arr.push({ timestamp: ts, value: '--', raw: '--' });
              });
              param.values = arr;
            });
          });
        };

        console.log('è®¾å¤‡æ•°æ®åŠ è½½å®Œæˆï¼ˆä»…ä¿ç•™é‡‡æ ·å¸§ï¼‰:', AppState.devicesData);
        console.log('å¯ç”¨æ—¥æœŸ:', AppState.availableDates);
        console.log('å½“å‰æ—¥æœŸé‡‡æ ·åå¸§æ•°:', AppState.timestamps.length);
      },

      updateLoadingUI() {
        const progressEl = document.getElementById('loading-progress');
        if (progressEl) {
          progressEl.textContent = `${AppState.loadingProgress}%`;
        }
      }
    };

    // ==================== é¡µé¢æ¸²æŸ“å™¨ ====================
    const Pages = {
      renderHome() {
        const menuItems = [
          { id: 'monitor', icon: 'ğŸ“Š', title: 'è®¾å¤‡ç›‘æ§', desc: 'æŸ¥çœ‹è®¾å¤‡å†å²è¿è¡ŒçŠ¶æ€' },
          { id: 'alerts', icon: 'ğŸ””', title: 'æŠ¥è­¦ç®¡ç†', desc: 'æ•…éšœé¢„è­¦ä¸é€šçŸ¥' }
        ];

        return `
          <div class="min-h-screen flex items-center justify-center p-8 fade-in">
            <div class="max-w-6xl w-full">
              <div class="text-center mb-12">
                <h1 class="text-6xl font-bold text-white mb-4">
                  <span class="mr-4">ğŸš¢</span>èˆ¹èˆ¶ç®¡ç†ç³»ç»Ÿ
                </h1>
                <p class="text-xl text-blue-200">æ™ºèƒ½ç›‘æ§ Â· ç²¾å‡†åˆ†æ Â· é«˜æ•ˆç®¡ç†</p>
              </div>
              
              <div class="max-w-3xl mx-auto grid grid-cols-1 sm:grid-cols-2 gap-6 justify-items-center">
                ${menuItems.map((item, idx) => `
                  <div class="menu-card bg-gradient-to-br from-blue-600 to-blue-800 p-8 rounded-2xl shadow-xl cursor-pointer border border-blue-500/30 w-full"
                       onclick="Router.navigate('${item.id}')"
                       style="animation-delay: ${idx * 0.1}s">
                    <div class="text-6xl mb-4">${item.icon}</div>
                    <h3 class="text-2xl font-bold text-white mb-2">${item.title}</h3>
                    <p class="text-blue-200 text-sm">${item.desc}</p>
                  </div>
                `).join('')}
              </div>
              
              <div class="mt-12 text-center text-gray-400 text-sm">
                <p>Â© 2024 èˆ¹èˆ¶æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ v2.0 - å¯è§†æ•°æ®ç‰ˆ</p>
              </div>
            </div>
          </div>
        `;
      },

      async renderMonitor() {
        if (Object.keys(AppState.devicesData).length === 0) {
          return `
            <div class="min-h-screen flex items-center justify-center">
              <div class="text-center">
                <div class="text-white text-2xl mb-4">æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...</div>
                <div class="text-cyan-400 text-4xl font-bold" id="loading-progress">0%</div>
              </div>
            </div>
          `;
        }

        const devices = AppState.devicesData;
        const currentTime = AppState.timestamps[AppState.currentTimeIndex] || '--';

        const html = `
          <div class="min-h-screen pb-32 fade-in">
            <div class="bg-slate-800 shadow-lg py-4 px-6 flex justify-between items-center">
              <div class="flex items-center space-x-4">
                <button onclick="Router.navigate('home')" 
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                  â† è¿”å›
                </button>
                <h1 class="text-2xl font-bold text-white">ğŸ“Š è®¾å¤‡ç›‘æ§</h1>
                <div class="px-3 py-1 bg-slate-700 rounded-lg">
                  <span class="text-cyan-400 text-sm font-mono">${currentTime}</span>
                </div>
              </div>
              <div class="text-gray-400 text-sm">
                å·²åŠ è½½ ${devices.length} ä¸ªè®¾å¤‡ | å½“å‰æ˜¾ç¤º ${AppState.timestamps.length} å¸§
              </div>
            </div>
            
            <div class="py-8 overflow-x-auto hide-scrollbar px-6">
              <div class="flex space-x-6" style="min-width: min-content;">
                ${devices.map(device => this.renderDeviceCard(device)).join('')}
              </div>
            </div>
            
            ${this.renderTimeline()}
          </div>
        `;

        return html;
      },

      async renderAlerts() {
        // ç¡®ä¿æ•°æ®ä¸è§„åˆ™å·²åŠ è½½
        if (Object.keys(AppState.devicesData).length === 0) {
          return `
            <div class="min-h-screen flex items-center justify-center">
              <div class="text-center">
                <div class="text-white text-2xl mb-4">æ­£åœ¨åŠ è½½æ•°æ®...</div>
                <div class="text-cyan-400 text-4xl font-bold" id="loading-progress">${AppState.loadingProgress || 0}%</div>
              </div>
            </div>
          `;
        }

        const currentDate = AppState.currentDate || AppState.availableDates[0];
        if (!currentDate) {
          return `<div class="p-8 text-white">æš‚æ— å¯ç”¨æ—¥æœŸ</div>`;
        }

        const alarmsByDevice = await DataManager.getOrBuildDailyAlarms(currentDate);
        const devices = AppState.devicesData;
        const totalAlarms = Object.values(alarmsByDevice).reduce((sum, arr) => sum + (arr?.length || 0), 0);

        const html = `
          <div class="min-h-screen pb-8 fade-in">
            <div class="bg-slate-800 shadow-lg py-4 px-6 flex justify-between items-center">
              <div class="flex items-center space-x-4">
                <button onclick="Router.navigate('home')" 
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                  â† è¿”å›
                </button>
                <h1 class="text-2xl font-bold text-white">ğŸ”” æŠ¥è­¦ç®¡ç†</h1>
                <div class="px-3 py-1 bg-slate-700 rounded-lg">
                  <span class="text-cyan-400 text-sm font-mono">${currentDate}</span>
                </div>
              </div>
              <div class="text-gray-300 text-sm">å½“æ—¥æŠ¥è­¦åˆè®¡ï¼š<span class="text-red-400 font-bold">${totalAlarms}</span> æ¡</div>
            </div>

            <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
            <div class="max-w-7xl mx-auto px-6 mt-4">
              <div class="relative inline-block">
                <button onclick="DatePickerHandler.toggle()" 
                        class="flex items-center space-x-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                  <span class="text-cyan-400 font-bold">ğŸ“… ${currentDate}</span>
                  <span class="text-gray-400 text-sm">â–¼</span>
                </button>
                <div id="date-picker-dropdown" 
                     class="absolute mt-2 left-0 bg-slate-800 rounded-lg shadow-2xl border border-slate-700 ${AppState.showDatePicker ? '' : 'hidden'}"
                     style="min-width: 300px; max-height: 400px; overflow-y: auto; z-index: 20;">
                  <div class="p-3 border-b border-slate-700">
                    <h4 class="text-white font-bold text-sm">é€‰æ‹©æ—¥æœŸ</h4>
                    <p class="text-gray-400 text-xs mt-1">å…± ${AppState.availableDates.length} ä¸ªæ—¥æœŸ</p>
                  </div>
                  <div class="p-2">
                    ${AppState.availableDates.map(date => {
          const isActive = date === currentDate;
          const originalFrameCount = AppState.dateTimestampsOriginal[date]?.length || 0;
          return `
                        <button onclick="DatePickerHandler.selectDate('${date}')"
                                class="w-full text-left px-4 py-3 rounded-lg transition-colors mb-1 ${isActive ? 'bg-cyan-600 text-white' : 'hover:bg-slate-700 text-gray-300'}">
                          <div class="flex justify-between items-center">
                            <div>
                              <div class="font-bold ${isActive ? 'text-white' : 'text-cyan-400'}">${date}</div>
                              <div class="text-xs ${isActive ? 'text-cyan-100' : 'text-gray-500'}">åˆ†é’Ÿç‚¹ï¼š${originalFrameCount}</div>
                            </div>
                            ${isActive ? '<span class="text-xl">âœ“</span>' : ''}
                          </div>
                        </button>`;
        }).join('')}
                  </div>
                </div>
              </div>
            </div>

            <!-- è®¾å¤‡æŠ¥è­¦å¡ç‰‡ -->
            <div class="py-6 overflow-x-auto hide-scrollbar px-6">
              <div class="flex space-x-6" style="min-width: min-content;">
                ${devices.map(device => this.renderAlertDeviceCard(device, alarmsByDevice[device.id] || [])).join('')}
              </div>
            </div>
          </div>
        `;
        return html;
      },

      renderAlertDeviceCard(device, alarms) {
        const alarmCount = alarms.length;
        const badge = alarmCount > 0
          ? `<span class="param-badge badge-error">${alarmCount} æ¡</span>`
          : `<span class="param-badge badge-normal">æ— æŠ¥è­¦</span>`;
        return `
          <div class="device-card relative w-56 h-64 flex-shrink-0"
               onclick="AlertsHandler.toggleDetail(${device.id}, event)">
            <div class="w-full h-full bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-lg flex flex-col items-center justify-center cursor-pointer p-4">
              <div class="text-6xl mb-3">${device.icon}</div>
              <h3 class="text-white font-bold text-center mb-2">${device.name}</h3>
              <div class="text-xs text-blue-200 text-center break-words w-full">å½“æ—¥æŠ¥è­¦</div>
              <div class="mt-2">${badge}</div>
              <div class="mt-2 text-xs text-blue-300">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</div>
            </div>
          </div>
        `;
      },

      renderDeviceCard(device) {
        // è·å–ç¬¬ä¸€ä¸ªæœ‰æ•ˆå‚æ•°ä½œä¸ºé¢„è§ˆ
        const firstParam = Object.values(device.parameters)[0];
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];
        let previewValue = '--';

        if (firstParam && firstParam.values.length > 0) {
          const valueData = TimelineHandler.findValueAtTime(firstParam, currentTime);
          previewValue = Utils.isErrorValue(valueData.value)
            ? 'error'
            : `${valueData.value} ${firstParam.unit}`;
        }

        return `
          <div class="device-card relative w-56 h-64 flex-shrink-0"
               onclick="DeviceHandler.toggleDetail(${device.id}, event)">
            <div class="w-full h-full bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-lg flex flex-col items-center justify-center cursor-pointer p-4">
              <div class="text-6xl mb-3">${device.icon}</div>
              <h3 class="text-white font-bold text-center mb-2">${device.name}</h3>
              <div class="text-xs text-blue-200 text-center break-words w-full device-preview-value">
                ${previewValue}
              </div>
              <div class="mt-2 text-xs text-blue-300">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
          </div>
        `;
      },

      renderTimeline() {
        if (AppState.timestamps.length === 0) return '';

        const totalFrames = AppState.timestamps.length;
        const progress = totalFrames <= 1 ? 0 : (AppState.currentTimeIndex / (totalFrames - 1)) * 100;
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];

        return `
          <div class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-lg border-t border-slate-700 p-4 z-40">
            <div class="max-w-7xl mx-auto">
              <!-- æ—¥æœŸé€‰æ‹©å’Œæ—¶é—´æ˜¾ç¤º -->
              <div class="flex justify-between items-center mb-3">
                <div class="flex items-center space-x-4">
                  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
                  <div class="relative">
                    <button onclick="DatePickerHandler.toggle()" 
                            class="flex items-center space-x-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                      <span class="text-cyan-400 font-bold">ğŸ“… ${Utils.formatDate(currentTime)}</span>
                      <span class="text-gray-400 text-sm">â–¼</span>
                    </button>
                    
                    <!-- æ—¥æœŸé€‰æ‹©ä¸‹æ‹‰æ¡† -->
                    <div id="date-picker-dropdown" 
                         class="absolute bottom-full left-0 mb-2 bg-slate-800 rounded-lg shadow-2xl border border-slate-700 ${AppState.showDatePicker ? '' : 'hidden'}"
                         style="min-width: 300px; max-height: 400px; overflow-y: auto;">
                      <div class="p-3 border-b border-slate-700">
                        <h4 class="text-white font-bold text-sm">é€‰æ‹©æ—¥æœŸ</h4>
                        <p class="text-gray-400 text-xs mt-1">å…± ${AppState.availableDates.length} ä¸ªæ—¥æœŸ</p>
                      </div>
                      <div class="p-2">
                        ${AppState.availableDates.map(date => {
          const isActive = date === AppState.currentDate;
          const originalFrameCount = AppState.dateTimestampsOriginal[date]?.length || 0;
          const sampledFrameCount = AppState.dateTimestamps[date]?.length || 0;
          return `
                            <button onclick="DatePickerHandler.selectDate('${date}')"
                                    class="w-full text-left px-4 py-3 rounded-lg transition-colors mb-1 ${isActive
              ? 'bg-cyan-600 text-white'
              : 'hover:bg-slate-700 text-gray-300'
            }">
                              <div class="flex justify-between items-center">
                                <div>
                                  <div class="font-bold ${isActive ? 'text-white' : 'text-cyan-400'}">${date}</div>
                                  <div class="text-xs ${isActive ? 'text-cyan-100' : 'text-gray-500'}">
                                    åŸå§‹: ${originalFrameCount} å¸§ â†’ é‡‡æ ·: ${sampledFrameCount} å¸§
                                  </div>
                                </div>
                                ${isActive ? '<span class="text-xl">âœ“</span>' : ''}
                              </div>
                            </button>
                          `;
        }).join('')}
                      </div>
                    </div>
                  </div>
                  
                  <!-- å½“å‰æ—¶é—´æ˜¾ç¤º -->
                  <div class="text-white font-mono text-sm">
                    <span class="text-gray-400">æ—¶é—´ï¼š</span>
                    <span class="text-cyan-400 font-bold ml-2 current-time-display">
                      ${Utils.formatTime(currentTime)}
                    </span>
                  </div>
                </div>
                
                <div class="text-gray-400 text-xs frame-counter">
                  å¸§ ${AppState.currentTimeIndex + 1} / ${AppState.timestamps.length}
                </div>
              </div>
              
              <!-- æ—¶é—´è½´æ»‘å— -->
              <div class="relative mb-4">
                <input type="range" 
                       id="timeline-slider"
                       min="0" 
                       max="${AppState.timestamps.length - 1}" 
                       value="${AppState.currentTimeIndex}"
                       onmousedown="TimelineHandler.onSliderStart()"
                       ontouchstart="TimelineHandler.onSliderStart()"
                       oninput="TimelineHandler.onSliderMove(this.value)"
                       onmouseup="TimelineHandler.onSliderEnd(this.value)"
                       ontouchend="TimelineHandler.onSliderEnd(this.value)"
                       onchange="TimelineHandler.onSliderEnd(this.value)"
                       class="w-full h-2"
                       style="background: linear-gradient(to right, #06b6d4 ${progress}%, #334155 ${progress}%)">
                
                <!-- æ—¶é—´åˆ»åº¦ -->
                <div class="flex justify-between mt-2 px-1">
                  ${this.generateTimeMarks()}
                </div>
              </div>
              
              <!-- æ§åˆ¶æŒ‰é’® -->
              <div class="flex justify-center items-center space-x-4">
                <button onclick="TimelineHandler.jumpToStart()" 
                        ${AppState.currentTimeIndex === 0 ? 'disabled' : ''}
                        class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-white text-sm">
                  â® é¦–å¸§
                </button>
                
                <button onclick="TimelineHandler.previous()" 
                        ${AppState.currentTimeIndex === 0 ? 'disabled' : ''}
                        class="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                  <span class="text-white text-xl">â—€</span>
                </button>
                
                <div class="px-4 py-2 bg-slate-800 rounded-lg">
                  <span class="text-cyan-400 font-mono text-sm frame-counter">
                    ${AppState.currentTimeIndex + 1} / ${AppState.timestamps.length}
                  </span>
                </div>
                
                <button onclick="TimelineHandler.next()"
                        ${AppState.currentTimeIndex >= AppState.timestamps.length - 1 ? 'disabled' : ''}
                        class="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                  <span class="text-white text-xl">â–¶</span>
                </button>
                
                <button onclick="TimelineHandler.jumpToEnd()" 
                        ${AppState.currentTimeIndex >= AppState.timestamps.length - 1 ? 'disabled' : ''}
                        class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-white text-sm">
                  æœ«å¸§ â­
                </button>
              </div>
            </div>
          </div>
        `;
      },

      generateTimeMarks() {
        const marks = [];
        const totalFrames = AppState.timestamps.length;
        const markCount = 8; // æ˜¾ç¤º8ä¸ªæ—¶é—´åˆ»åº¦

        if (totalFrames === 0) return '';

        // å¦‚æœå¸§æ•°è¾ƒå°‘ï¼Œåˆ™æ˜¾ç¤ºæ¯å¸§çš„æ—¶é—´
        if (totalFrames <= markCount) {
          for (let i = 0; i < totalFrames; i++) {
            const timestamp = AppState.timestamps[i];
            if (timestamp) marks.push(`<span class="text-xs text-gray-500">${Utils.formatTime(timestamp)}</span>`);
          }
          return marks.join('');
        }

        for (let i = 0; i <= markCount; i++) {
          const index = Math.floor((i / markCount) * (totalFrames - 1));
          const timestamp = AppState.timestamps[index];
          if (timestamp) {
            marks.push(`<span class="text-xs text-gray-500">${Utils.formatTime(timestamp)}</span>`);
          }
        }

        return marks.join('');
      },

      renderPlaceholder(title, icon) {
        return `
          <div class="min-h-screen flex items-center justify-center fade-in">
            <div class="text-center">
              <div class="text-9xl mb-6">${icon}</div>
              <h2 class="text-4xl font-bold text-white mb-4">${title}</h2>
              <p class="text-gray-400 mb-8">è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
              <button onclick="window.location.href='../function.html'" 
                      class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                è¿”å›æ ¸å¿ƒåŠŸèƒ½
              </button>
            </div>
          </div>
        `;
      }
    };

    // ==================== æŠ¥è­¦äº¤äº’å¤„ç†å™¨ ====================
    const AlertsHandler = {
      async toggleDetail(deviceId, event) {
        event.stopPropagation();
        const existingModal = document.getElementById('alert-detail-modal');
        if (existingModal) existingModal.remove();

        const device = AppState.devicesData.find(d => d.id === deviceId);
        if (!device) return;
        const currentDate = AppState.currentDate || AppState.availableDates[0];
        const alarmsByDevice = await DataManager.getOrBuildDailyAlarms(currentDate);
        const alarms = alarmsByDevice[deviceId] || [];

        const modal = document.createElement('div');
        modal.id = 'alert-detail-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

        const content = document.createElement('div');
        content.className = 'bg-slate-800 rounded-xl shadow-2xl max-w-5xl w-full max-h-[85vh] overflow-y-auto slide-up';
        content.onclick = (e) => e.stopPropagation();

        const grouped = alarms.reduce((acc, a) => {
          (acc[a.minute] = acc[a.minute] || []).push(a);
          return acc;
        }, {});

        const minutes = Object.keys(grouped).sort();

        content.innerHTML = `
          <div class="p-6">
            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
              <div class="flex items-center space-x-3">
                <span class="text-6xl">${device.icon}</span>
                <div>
                  <h3 class="text-3xl font-bold text-white">${device.name}</h3>
                  <p class="text-sm text-gray-400 mt-1">${currentDate} æŠ¥è­¦æ˜ç»†ï¼ˆåˆ†é’Ÿç²’åº¦ï¼‰</p>
                </div>
              </div>
              <button onclick="document.getElementById('alert-detail-modal').remove();" 
                      class="text-gray-400 hover:text-white text-4xl leading-none p-2 transition-colors">Ã—</button>
            </div>

            ${minutes.length === 0 ? `<div class="text-center text-gray-400">å½“æ—¥æ— æŠ¥è­¦</div>` : ''}

            ${minutes.map(min => `
              <div class="mb-4 bg-slate-700/40 rounded-lg">
                <div class="px-4 py-2 border-b border-slate-600 flex justify-between items-center">
                  <div class="text-cyan-400 font-mono">${min}</div>
                  <div class="param-badge badge-error">${grouped[min].length} æ¡</div>
                </div>
                <div class="p-4">
                  <div class="space-y-2">
                    ${grouped[min].map(a => `
                      <div class="flex justify-between items-center bg-slate-800/70 rounded-md px-3 py-2">
                        <div class="text-gray-200 text-sm">${a.paramName}</div>
                        <div class="text-sm text-gray-400">
                          <span class="text-red-400 font-bold mr-2">${a.value} ${a.unit}</span>
                          <span>èŒƒå›´: ${a.low ?? '-'} ~ ${a.high ?? '-'} ${a.unit || ''}</span>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            `).join('')}

            <div class="mt-6 pt-4 border-t border-slate-700 text-center text-sm text-gray-400">
              <p>ğŸ’¡ æŠ¥è­¦ä»¥åˆ†é’Ÿä¸ºå•ä½ç»Ÿè®¡ï¼Œé˜ˆå€¼æ¥æºäºè®¾å¤‡å‚æ•°è¯¦æƒ…é…ç½®</p>
            </div>
          </div>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);
      }
    };

    // ==================== æ—¥æœŸé€‰æ‹©å™¨å¤„ç†å™¨ ====================
    const DatePickerHandler = {
      toggle() {
        AppState.showDatePicker = !AppState.showDatePicker;
        const dropdown = document.getElementById('date-picker-dropdown');
        if (dropdown) {
          dropdown.classList.toggle('hidden');
        }
      },

      selectDate(date) {
        if (AppState.currentDate === date) {
          this.toggle();
          return;
        }

        AppState.currentDate = date;
        AppState.timestamps = AppState.dateTimestamps[date] || [];
        AppState.currentTimeIndex = 0;
        AppState.showDatePicker = false;

        // åˆ‡æ¢æ—¥æœŸååŸºäºåˆ†é’Ÿçº§æ—¶é—´æˆ³é‡å»ºå„å‚æ•°çš„ values
        if (typeof DataManager.projectValuesForCurrentDate === 'function') {
          DataManager.projectValuesForCurrentDate();
        }

        Router.render();
      },

      close() {
        AppState.showDatePicker = false;
        const dropdown = document.getElementById('date-picker-dropdown');
        if (dropdown) {
          dropdown.classList.add('hidden');
        }
      }
    };

    // ==================== æ—¶é—´è½´å¤„ç†å™¨ ====================
    const TimelineHandler = {
      updateTimeout: null,

      previous() {
        AppState.currentTimeIndex = Math.max(0, AppState.currentTimeIndex - 1);
        this.updateDisplayImmediate();
      },

      next() {
        AppState.currentTimeIndex = Math.min(
          AppState.timestamps.length - 1,
          AppState.currentTimeIndex + 1
        );
        this.updateDisplayImmediate();
      },

      jumpToStart() {
        AppState.currentTimeIndex = 0;
        this.updateDisplayImmediate();
      },

      jumpToEnd() {
        AppState.currentTimeIndex = AppState.timestamps.length - 1;
        this.updateDisplayImmediate();
      },

      onSliderStart() {
        AppState.isDragging = true;
      },

      onSliderMove(value) {
        // æ‹–åŠ¨è¿‡ç¨‹ä¸­åªæ›´æ–°UIé¢„è§ˆï¼Œä¸åŠ è½½æ•°æ®
        const newIndex = parseInt(value);
        AppState.pendingTimeIndex = newIndex;
        this.updateSliderUI(newIndex);
        this.updateTimePreview(newIndex);
      },

      onSliderEnd(value) {
        // æ¾å¼€åæ‰çœŸæ­£åŠ è½½æ•°æ®
        AppState.isDragging = false;
        const newIndex = parseInt(value);
        AppState.currentTimeIndex = newIndex;
        AppState.pendingTimeIndex = null;
        this.updateDisplayImmediate();
      },

      // ä»…æ›´æ–°æ»‘å—UIï¼ˆæ‹–åŠ¨ä¸­ï¼‰
      updateSliderUI(index) {
        const slider = document.getElementById('timeline-slider');
        const total = AppState.timestamps.length;
        if (slider && total > 0) {
          const progress = total <= 1 ? 0 : (index / (total - 1)) * 100;
          slider.style.background = `linear-gradient(to right, #06b6d4 ${progress}%, #334155 ${progress}%)`;
        }
      },

      // ä»…æ›´æ–°æ—¶é—´é¢„è§ˆï¼ˆæ‹–åŠ¨ä¸­ï¼‰
      updateTimePreview(index) {
        const currentTime = AppState.timestamps[index];
        document.querySelectorAll('.current-time-display').forEach(el => {
          el.textContent = Utils.formatTime(currentTime);
        });
        document.querySelectorAll('.frame-counter').forEach(el => {
          el.textContent = `${index + 1} / ${AppState.timestamps.length}`;
        });
      },

      // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºï¼ˆæ¾å¼€å/ç‚¹å‡»æŒ‰é’®ï¼‰- ä¼˜åŒ–ç‰ˆ
      updateDisplayImmediate() {
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];

        // 1. ç«‹å³æ›´æ–°UIå…ƒç´ ï¼ˆæ— å»¶è¿Ÿï¼‰
        const slider = document.getElementById('timeline-slider');
        if (slider) {
          slider.value = AppState.currentTimeIndex;
          this.updateSliderUI(AppState.currentTimeIndex);
        }
        this.updateTimePreview(AppState.currentTimeIndex);
        this.updateButtonStates();

        // 2. æ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœæœ‰ç¼“å­˜ç›´æ¥ä½¿ç”¨
        const cachedData = AppState.dataCache.get(currentTime);
        if (cachedData) {
          this.applyDeviceCardData(cachedData);
          if (AppState.activeDetailId !== null) {
            DeviceHandler.updateDetailContent(AppState.activeDetailId);
          }
          return;
        }

        // 3. æ— ç¼“å­˜æ—¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        Utils.showLoading('åŠ è½½æ•°æ®...');

        // 4. ä½¿ç”¨ setTimeout åˆ†æ‰¹åŠ è½½ï¼Œé¿å…é˜»å¡UI
        setTimeout(() => {
          const deviceCardData = {};

          // é¢„å…ˆè®¡ç®—æ‰€æœ‰è®¾å¤‡çš„æ•°æ®
          AppState.devicesData.forEach(device => {
            const firstParam = Object.values(device.parameters)[0];
            if (firstParam) {
              const valueData = this.findValueAtTime(firstParam, currentTime);
              deviceCardData[device.id] = {
                value: valueData.value,
                unit: firstParam.unit
              };
            }
          });

          // ç¼“å­˜æ•°æ®
          AppState.dataCache.set(currentTime, deviceCardData);

          // åº”ç”¨æ•°æ®
          this.applyDeviceCardData(deviceCardData);

          // æ›´æ–°è¯¦æƒ…çª—å£
          if (AppState.activeDetailId !== null) {
            DeviceHandler.updateDetailContent(AppState.activeDetailId);
          }

          // éšè—åŠ è½½åŠ¨ç”»
          Utils.hideLoading();
        }, 50); // 50mså»¶è¿Ÿï¼Œè®©UIå…ˆæ›´æ–°
      },

      // åº”ç”¨è®¾å¤‡å¡ç‰‡æ•°æ®ï¼ˆä¼˜åŒ–åçš„æ‰¹é‡æ›´æ–°ï¼‰
      applyDeviceCardData(deviceCardData) {
        const cards = document.querySelectorAll('.device-card');
        const fragment = document.createDocumentFragment();

        cards.forEach((card, idx) => {
          const valueEl = card.querySelector('.device-preview-value');
          if (valueEl && deviceCardData[idx]) {
            const data = deviceCardData[idx];
            const displayValue = Utils.isErrorValue(data.value)
              ? 'ERROR'
              : `${data.value} ${data.unit}`;
            valueEl.textContent = displayValue;
          }
        });
      },

      // æ›´æ–°æŒ‰é’®ç¦ç”¨çŠ¶æ€
      updateButtonStates() {
        const isFirst = AppState.currentTimeIndex === 0;
        const isLast = AppState.currentTimeIndex >= AppState.timestamps.length - 1;

        // æ›´æ–°é¦–å¸§/ä¸Šä¸€å¸§æŒ‰é’®
        document.querySelectorAll('button[onclick*="jumpToStart"], button[onclick*="previous"]').forEach(btn => {
          if (isFirst) {
            btn.setAttribute('disabled', 'disabled');
            btn.classList.add('opacity-30', 'cursor-not-allowed');
          } else {
            btn.removeAttribute('disabled');
            btn.classList.remove('opacity-30', 'cursor-not-allowed');
          }
        });

        // æ›´æ–°æœ«å¸§/ä¸‹ä¸€å¸§æŒ‰é’®
        document.querySelectorAll('button[onclick*="jumpToEnd"], button[onclick*="next"]').forEach(btn => {
          if (isLast) {
            btn.setAttribute('disabled', 'disabled');
            btn.classList.add('opacity-30', 'cursor-not-allowed');
          } else {
            btn.removeAttribute('disabled');
            btn.classList.remove('opacity-30', 'cursor-not-allowed');
          }
        });
      },

      // æŸ¥æ‰¾æŒ‡å®šæ—¶é—´ç‚¹çš„å‚æ•°å€¼ï¼šå¯¹ param.valuesï¼ˆæŒ‰æ—¶é—´æˆ³é¡ºåºï¼‰ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾åŒ¹é… targetTime
      findValueAtTime(param, targetTime) {
        if (!param || !param.values || param.values.length === 0) {
          return { value: '--', raw: '--' };
        }

        const values = param.values;

        // å¿«é€Ÿæ£€æŸ¥è¾¹ç•Œ
        if (values[0].timestamp === targetTime) return values[0];
        const last = values[values.length - 1];
        if (last.timestamp === targetTime) return last;

        // äºŒåˆ†æŸ¥æ‰¾ï¼šå®šä½ä¸ targetTime ç²¾ç¡®åŒ¹é…çš„ä½ç½®
        let lo = 0;
        let hi = values.length - 1;
        while (lo <= hi) {
          const mid = Math.floor((lo + hi) / 2);
          const t = values[mid].timestamp;
          if (t === targetTime) return values[mid];
          if (t < targetTime) lo = mid + 1;
          else hi = mid - 1;
        }

        // æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œä½¿ç”¨æœ€è¿‘çš„é‚»è¿‘å€¼ï¼ˆhi ä¸ºå°äº targetTime çš„ç´¢å¼•ï¼Œlo ä¸ºå¤§äº targetTime çš„ç´¢å¼•ï¼‰
        const choose = (idx) => (idx >= 0 && idx < values.length) ? values[idx] : null;
        const left = choose(hi);
        const right = choose(lo);

        if (!left) return right || { value: '--', raw: '--' };
        if (!right) return left || { value: '--', raw: '--' };

        // æ¯”è¾ƒæ—¶é—´å·®ï¼ˆå°† 'YYYY-MM-DD HH:MM:SS' è½¬ä¸ºå¯è§£æçš„ ISO å­—ç¬¦ä¸²ï¼‰
        const toMs = (ts) => {
          try {
            // å…¼å®¹æŠŠç©ºæ ¼æ›¿æ¢ä¸º T
            return Date.parse(ts.replace(' ', 'T')) || 0;
          } catch (e) {
            return 0;
          }
        };

        const targetMs = toMs(targetTime);
        const leftMs = toMs(left.timestamp);
        const rightMs = toMs(right.timestamp);

        return (Math.abs(targetMs - leftMs) <= Math.abs(rightMs - targetMs)) ? left : right;
      }
    };

    // ==================== è®¾å¤‡äº¤äº’å¤„ç†å™¨ ====================
    const DeviceHandler = {
      toggleDetail(deviceId, event) {
        event.stopPropagation();

        const existingModal = document.getElementById('device-detail-modal');
        if (existingModal) {
          if (AppState.activeDetailId === deviceId) {
            existingModal.remove();
            AppState.activeDetailId = null;
            return;
          }
          existingModal.remove();
        }

        AppState.activeDetailId = deviceId;
        const device = AppState.devicesData.find(d => d.id === deviceId);
        if (!device) return;

        const modal = document.createElement('div');
        modal.id = 'device-detail-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.remove();
            AppState.activeDetailId = null;
          }
        };

        const content = document.createElement('div');
        content.className = 'bg-slate-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-y-auto slide-up';
        content.onclick = (e) => e.stopPropagation();

        this.renderDetailContent(content, device);

        modal.appendChild(content);
        document.body.appendChild(modal);
      },

      renderDetailContent(container, device) {
        const currentTime = AppState.timestamps[AppState.currentTimeIndex];
        const paramEntries = Object.entries(device.parameters);

        // æŒ‰å‚æ•°åˆ†ç±»
        const categories = {
          'ç”µå‹å‚æ•°': [],
          'ç”µæµå‚æ•°': [],
          'åŠŸç‡å‚æ•°': [],
          'é€Ÿåº¦/è½¬é€Ÿ': [],
          'å…¶ä»–å‚æ•°': []
        };

        paramEntries.forEach(([key, param]) => {
          if (param.displayName.includes('ç”µå‹')) {
            categories['ç”µå‹å‚æ•°'].push([key, param]);
          } else if (param.displayName.includes('ç”µæµ')) {
            categories['ç”µæµå‚æ•°'].push([key, param]);
          } else if (param.displayName.includes('åŠŸç‡')) {
            categories['åŠŸç‡å‚æ•°'].push([key, param]);
          } else if (param.displayName.includes('è½¬é€Ÿ') || param.displayName.includes('é€Ÿåº¦')) {
            categories['é€Ÿåº¦/è½¬é€Ÿ'].push([key, param]);
          } else {
            categories['å…¶ä»–å‚æ•°'].push([key, param]);
          }
        });

        container.innerHTML = `
          <div class="p-6">
            <!-- å¤´éƒ¨ -->
            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
              <div class="flex items-center space-x-3">
                <span class="text-6xl">${device.icon}</span>
                <div>
                  <h3 class="text-3xl font-bold text-white">${device.name}</h3>
                  <p class="text-sm text-gray-400 mt-1">å®æ—¶è¿è¡Œå‚æ•°ç›‘æ§</p>
                </div>
              </div>
              <button onclick="document.getElementById('device-detail-modal').remove(); AppState.activeDetailId = null;" 
                      class="text-gray-400 hover:text-white text-4xl leading-none p-2 transition-colors">
                Ã—
              </button>
            </div>
            
            <!-- æ—¶é—´æ˜¾ç¤º -->
            <div class="mb-6 bg-slate-700/50 rounded-lg p-4 flex justify-between items-center">
              <div>
                <span class="text-gray-400 text-sm">å½“å‰æ—¶é—´ç‚¹</span>
                <div class="text-cyan-400 font-mono text-xl mt-1">${currentTime || '--'}</div>
              </div>
              <div class="text-right">
                <span class="text-gray-400 text-sm">å‚æ•°æ•°é‡</span>
                <div class="text-white text-xl font-bold mt-1">${paramEntries.length} é¡¹</div>
              </div>
            </div>
            
            <!-- å‚æ•°åˆ†ç±»æ˜¾ç¤º -->
            ${Object.entries(categories).filter(([cat, items]) => items.length > 0).map(([category, items]) => `
              <div class="mb-6">
                <h4 class="text-lg font-bold text-cyan-400 mb-3 flex items-center">
                  <span class="w-1 h-6 bg-cyan-400 mr-2"></span>
                  ${category}
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  ${items.map(([key, param]) => {
          const valueData = TimelineHandler.findValueAtTime(param, currentTime);
          const isError = Utils.isErrorValue(valueData.value);
          const displayValue = isError ? 'ERROR' : valueData.value;
          const status = Utils.getValueStatus(valueData.value, FieldMapping[key]);

          return `
                      <div class="bg-slate-700/50 rounded-lg p-4 hover:bg-slate-700/70 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                          <span class="text-gray-300 text-sm font-medium">${param.displayName}</span>
                          <span class="param-badge ${isError ? 'badge-error' : 'badge-normal'}">
                            ${isError ? 'ERR' : 'OK'}
                          </span>
                        </div>
                        <div class="flex items-end justify-between">
                          <div class="text-2xl font-bold ${isError ? 'text-red-400' : 'text-white'}">
                            ${displayValue}
                          </div>
                          <div class="text-gray-400 text-sm">${param.unit}</div>
                        </div>
                        ${!isError && parseFloat(displayValue) ? `
                          <div class="mt-2 w-full bg-slate-600 rounded-full h-1.5">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-1.5 rounded-full transition-all duration-300" 
                                 style="width: ${Math.min(Math.abs(parseFloat(displayValue) / 100), 1) * 100}%"></div>
                          </div>
                        ` : ''}
                      </div>
                    `;
        }).join('')}
                </div>
              </div>
            `).join('')}
            
            <!-- åº•éƒ¨æç¤º -->
            <div class="mt-6 pt-4 border-t border-slate-700 text-center text-sm text-gray-400">
              <p>ğŸ’¡ æ‹–åŠ¨æ—¶é—´è½´å¯æŸ¥çœ‹å†å²æ•°æ® | æ•°æ®è‡ªåŠ¨åŒæ­¥æ›´æ–°</p>
            </div>
          </div>
        `;
      },

      updateDetailContent(deviceId) {
        const modal = document.getElementById('device-detail-modal');
        if (!modal) return;

        const device = AppState.devicesData.find(d => d.id === deviceId);
        if (!device) return;

        const content = modal.querySelector('.bg-slate-800');
        if (content) {
          this.renderDetailContent(content, device);
        }
      }
    };

    // ==================== è·¯ç”±ç®¡ç† ====================
    const Router = {
      async navigate(page) {
        AppState.currentPage = page;
        await this.render();
      },

      async render() {
        const app = document.getElementById('app');
        let html = '';

        switch (AppState.currentPage) {
          case 'home':
            html = Pages.renderHome();
            break;
          case 'monitor':
            // å¦‚æœæ•°æ®æœªåŠ è½½ï¼Œå…ˆåŠ è½½
            if (Object.keys(AppState.devicesData).length === 0) {
              html = await Pages.renderMonitor();
              app.innerHTML = html;
              await DataManager.loadAllData();
              html = await Pages.renderMonitor();
              app.innerHTML = html;
              // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
              setTimeout(() => TimelineHandler.updateButtonStates(), 100);
              return;
            }
            html = await Pages.renderMonitor();
            // æ¸²æŸ“åæ›´æ–°æŒ‰é’®çŠ¶æ€
            app.innerHTML = html;
            setTimeout(() => TimelineHandler.updateButtonStates(), 100);
            break;
          case 'alerts':
            // å¦‚æœæ•°æ®æœªåŠ è½½ï¼Œå…ˆåŠ è½½
            if (Object.keys(AppState.devicesData).length === 0) {
              html = await Pages.renderAlerts();
              app.innerHTML = html;
              await DataManager.loadAllData();
              html = await Pages.renderAlerts();
              app.innerHTML = html;
              return;
            }
            html = await Pages.renderAlerts();
            break;
          default:
            html = Pages.renderHome();
        }

        app.innerHTML = html;
      }
    };

    // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
    window.addEventListener('DOMContentLoaded', () => {
      Router.render();

      // ç‚¹å‡»å¤–éƒ¨å…³é—­æ—¥æœŸé€‰æ‹©å™¨
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('date-picker-dropdown');
        const button = e.target.closest('button[onclick*="DatePickerHandler.toggle"]');
        if (dropdown && !dropdown.contains(e.target) && !button) {
          DatePickerHandler.close();
        }
      });
    });
  </script>
</body>

</html>